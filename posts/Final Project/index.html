<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.537">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Yichen Wang, Xipeng Du, Manshu Huang">
<meta name="dcterms.date" content="2024-03-01">

<title>myblog - Option Pricing with One-dimension Convolutional Neural Network</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">myblog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">Contact info</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Option Pricing with One-dimension Convolutional Neural Network</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">final project</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Yichen Wang, Xipeng Du, Manshu Huang </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 1, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<p>Option is a financial contract that give the buyer the right to buy or sell certain quantity of assets as specific strike price on or before maturity date, and the buyer needs to pay premium or “option price” in this context to the seller of this contract. Option pricing is a way to evaluate the fair value of an option which corresponds to its striking price, maturity time and risk involved with the stock. In this project, we aim to use one-dimension convolutional neural network to predict the intrinsic value of the call and put options with regard to its final payoff from the contract. Without loss of generality, we used the S&amp;P 500 index as the stock of choice.</p>
<p>The whole project contains three parts: Data preprocessing, CNN model construction and result analysis, and Flask Web Application creation. We first utilize the API and Yahoo Finance to get rudimentary data, do systematic data preprocessing using various techniques, including cleaning, scaling, and database creation using sqlite3. Then we construct the 1D CNN model to predict the option price using pytorch. CNN, namely Convolutional Neural Network, is a type of neural network that is mainly used for image recognition and classification. Here we adopt the 1D version of CNN to predict the intrinsic value of the options. Then we proceed with a robust training session for hyperparameter tuning, early stopping, model evaluation, and result visualization. Finally, we create a web application using Flask to visualize the result and provide a user-friendly interface for users to interact with the model.</p>
<p>All code, data, and results are available on our GitHub repository: <strong>https://github.com/Yichen-Wang-2003/24W-PIC16B-Group4.git</strong></p>
<p>Regarding more details, please refer to the flow chart below.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="flow.png" class="img-fluid figure-img"></p>
<figcaption>flowchart</figcaption>
</figure>
</div>
<section id="part-1-introduction-data-preprocessing" class="level1">
<h1>Part 1: Introduction &amp; Data Preprocessing</h1>
<section id="data-acquisition" class="level2">
<h2 class="anchored" data-anchor-id="data-acquisition">1.1 Data Acquisition</h2>
<p>For the first step of our project is acquiring the data. We found the source data that satisfy our need: Optiondx[<a href="https://www.optionsdx.com/product/spy-option-chains/">link</a>]. This websites contains a text based datasets with end of date data for free. The following is the features. Then, realizing we might need real time stock price data for target, we utilize a package called yfinance which calls yahoo finance’s unofficial api to download data from a time range by <code>yf.download</code> function, which gets us an adjusted closed data at the end of each trading date.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># getting stock prices for target evaluation</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> pd.DataFrame(yf.download([<span class="st">'SPY'</span>], start<span class="op">=</span><span class="st">"2023-06-01"</span>, </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    end<span class="op">=</span><span class="st">"2023-12-31"</span>)[<span class="st">'Adj Close'</span>])</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>target</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
[*********************100%%**********************] 1 of 1 completed
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
Adj Close
</th>
</tr>
<tr>
<th>
Date
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
2023-06-01
</th>
<td>
415.798767
</td>
</tr>
<tr>
<th>
2023-06-02
</th>
<td>
421.811676
</td>
</tr>
<tr>
<th>
2023-06-05
</th>
<td>
421.003418
</td>
</tr>
<tr>
<th>
2023-06-06
</th>
<td>
421.920135
</td>
</tr>
<tr>
<th>
2023-06-07
</th>
<td>
420.461212
</td>
</tr>
<tr>
<th>
…
</th>
<td>
…
</td>
</tr>
<tr>
<th>
2023-12-22
</th>
<td>
472.182892
</td>
</tr>
<tr>
<th>
2023-12-26
</th>
<td>
474.176697
</td>
</tr>
<tr>
<th>
2023-12-27
</th>
<td>
475.034058
</td>
</tr>
<tr>
<th>
2023-12-28
</th>
<td>
475.213501
</td>
</tr>
<tr>
<th>
2023-12-29
</th>
<td>
473.837769
</td>
</tr>
</tbody>
</table>
<p>
147 rows × 1 columns
</p>
</div>
<p>## 1.2 Data Cleaning</p>
<p>For data cleaning, we first import necessary packages including numpy, matplotlib, and sqlite3.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># importing neccessary packages</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We have first removed all the contracts that are later than 2023 as a cutoff point which we will be unable to evaluate their target value at a future date.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the data from Jan 2023 to May 2023</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df_2023_h1 <span class="op">=</span> pd.DataFrame()</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> [<span class="dv">202301</span>, <span class="dv">202302</span>, <span class="dv">202303</span>, <span class="dv">202304</span>,  <span class="dv">202305</span>]:</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    df_2023_h1 <span class="op">=</span> pd.concat([df_2023_h1, pd.read_table(<span class="ss">f'data/spy_eod_</span><span class="sc">{</span>i<span class="sc">}</span><span class="ss">.txt'</span>, </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    sep<span class="op">=</span><span class="st">','</span>)], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>df_2023_h1.columns <span class="op">=</span> df_2023_h1.columns.<span class="bu">str</span>.strip()</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co"># also drop expiration date later than 2024</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>df_2023_h1 <span class="op">=</span> df_2023_h1[df_2023_h1[<span class="st">'[EXPIRE_DATE]'</span>] <span class="op">&lt;=</span> <span class="st">' 2023-12-31'</span>]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>df_2023_h1 <span class="op">=</span> df_2023_h1[df_2023_h1[<span class="st">'[EXPIRE_DATE]'</span>] <span class="op">&gt;=</span> <span class="st">' 2023-06-01'</span>]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>df_2023_h1 <span class="op">=</span> df_2023_h1.reset_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We strip away all the spaces of the column names in this step for easier access, and removed the entries that target cannot be calculated.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># change the string dates to datetime64</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>df_2023_h1[<span class="st">'[QUOTE_DATE]'</span>] <span class="op">=</span> df_2023_h1[<span class="st">'[QUOTE_DATE]'</span>].<span class="bu">apply</span>(np.datetime64)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>df_2023_h1[<span class="st">'[EXPIRE_DATE]'</span>] <span class="op">=</span> df_2023_h1[<span class="st">'[EXPIRE_DATE]'</span>].<span class="bu">apply</span>(np.datetime64)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># merge our adj close stock data on EXPIRE_DATE</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>target[<span class="st">'[EXPIRE_DATE]'</span>] <span class="op">=</span> target.index</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>target[<span class="st">'[EXPIRE_DATE]'</span>].astype(<span class="st">'datetime64[ns]'</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>df_2023_h1 <span class="op">=</span> pd.merge(df_2023_h1, target, on <span class="op">=</span> <span class="st">'[EXPIRE_DATE]'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="setting-targets" class="level2">
<h2 class="anchored" data-anchor-id="setting-targets">1.3 Setting targets</h2>
<p>Then, we have to set a target for our machine learning model. We first utilized a naive estimation of the option price, then start to focus on the intrinsic value of call option. with price = (K - S). <br> Later, we set our target as intrinsic value of price based on payoff of call and put options, based on the function of discounted price = (K - S) * e^(-rt) where r is a risk free investment rate.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> data_cleansing_function <span class="im">import</span> target_setting</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> inspect</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(inspect.getsource(target_setting))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>df_2023_h1 <span class="op">=</span> target_setting(df_2023_h1)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> df_2023_h1[<span class="st">'discounted_price'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> target_setting(df):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    vectorized operation to calculate the target value based on formula</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'-rt'</span>] <span class="op">=</span> <span class="op">-</span><span class="fl">0.04</span><span class="op">*</span>(df[<span class="st">'[EXPIRE_UNIX]'</span>] <span class="op">-</span> df[<span class="st">'[QUOTE_UNIXTIME]'</span>])<span class="op">/</span>(<span class="dv">3600</span><span class="op">*</span><span class="dv">365</span><span class="op">*</span><span class="dv">24</span>)  </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># unix time is based on seconds</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'price_diff'</span>] <span class="op">=</span> df[<span class="st">'[STRIKE]'</span>] <span class="op">-</span> df[<span class="st">'Adj Close'</span>]</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'exp(-rt)'</span>] <span class="op">=</span> df[<span class="st">'-rt'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: math.exp(x))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.loc[:, <span class="op">~</span>df.columns.<span class="bu">str</span>.contains(<span class="st">'^Unnamed'</span>)]   </span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'discounted_price'</span>] <span class="op">=</span> df[<span class="st">'price_diff'</span>] <span class="op">*</span> df[<span class="st">'exp(-rt)'</span>]</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We normalize all numerical columns with a standard scaler.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df_2023_h1 <span class="op">=</span> df_2023_h1[[<span class="st">'[EXPIRE_UNIX]'</span>, <span class="st">'[QUOTE_DATE]'</span>, <span class="st">'[EXPIRE_DATE]'</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a> <span class="st">'[STRIKE]'</span>, <span class="st">'[UNDERLYING_LAST]'</span>, <span class="st">'[C_DELTA]'</span>, <span class="st">'[C_GAMMA]'</span>, <span class="st">'[C_VEGA]'</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>       <span class="st">'[C_THETA]'</span>, <span class="st">'[C_RHO]'</span>, <span class="st">'[C_IV]'</span>, <span class="st">'[C_VOLUME]'</span>,<span class="st">'[C_BID]'</span>, <span class="st">'[C_ASK]'</span>, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">'[P_DELTA]'</span>, <span class="st">'[P_GAMMA]'</span>, <span class="st">'[P_VEGA]'</span>, <span class="st">'[P_THETA]'</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>       <span class="st">'[P_RHO]'</span>, <span class="st">'[P_IV]'</span>, <span class="st">'[P_VOLUME]'</span>, <span class="st">'[P_BID]'</span>, <span class="st">'[P_ASK]'</span>, <span class="st">'Adj Close'</span>]]</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>df_2023_h1 <span class="op">=</span> df_2023_h1.replace(<span class="vs">r'^\s*$'</span>, <span class="dv">0</span>, regex<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic normalization and standardization</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="co"># run block of code and catch warnings</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> warnings.catch_warnings():</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ignore all caught warnings</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># execute code that will generate warnings</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    numeric_cols <span class="op">=</span> [<span class="st">'[EXPIRE_UNIX]'</span>, <span class="st">'[STRIKE]'</span>, <span class="st">'[UNDERLYING_LAST]'</span>, </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'[C_DELTA]'</span>, <span class="st">'[C_GAMMA]'</span>, <span class="st">'[C_VEGA]'</span>,</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>       <span class="st">'[C_THETA]'</span>, <span class="st">'[C_RHO]'</span>, <span class="st">'[C_IV]'</span>, <span class="st">'[C_VOLUME]'</span>,<span class="st">'[C_BID]'</span>, <span class="st">'[C_ASK]'</span>, </span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>       <span class="st">'[P_DELTA]'</span>, <span class="st">'[P_GAMMA]'</span>, <span class="st">'[P_VEGA]'</span>, <span class="st">'[P_THETA]'</span>,</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>       <span class="st">'[P_RHO]'</span>, <span class="st">'[P_IV]'</span>, <span class="st">'[P_VOLUME]'</span>, <span class="st">'[P_BID]'</span>, <span class="st">'[P_ASK]'</span>]  </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    scaler <span class="op">=</span> StandardScaler()</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    df_2023_h1[numeric_cols] <span class="op">=</span> scaler.fit_transform(df_2023_h1[numeric_cols])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>target</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dv">0</span>        <span class="op">-</span><span class="fl">279.724554</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>        <span class="op">-</span><span class="fl">269.902630</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>        <span class="op">-</span><span class="fl">260.080706</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>        <span class="op">-</span><span class="fl">250.258782</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>        <span class="op">-</span><span class="fl">245.347819</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>             ...    </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="dv">127485</span>    <span class="op">-</span><span class="fl">17.254494</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="dv">127486</span>    <span class="op">-</span><span class="fl">12.346804</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="dv">127487</span>     <span class="op">-</span><span class="fl">7.439115</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="dv">127488</span>     <span class="op">-</span><span class="fl">2.531426</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="dv">127489</span>      <span class="fl">2.376263</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>Name: discounted_price, Length: <span class="dv">127490</span>, dtype: float64</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Output the data to sqlite database.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># output to sqlite database for others to use</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">"data/tables.db"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>df_2023_h1.to_sql(<span class="st">"df_2023_h1_feature"</span>, conn, if_exists <span class="op">=</span> <span class="st">"replace"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>target.to_sql(<span class="st">"df_2023_h1_target"</span>, conn, if_exists <span class="op">=</span> <span class="st">"replace"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>conn.close()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="data-structures" class="level2">
<h2 class="anchored" data-anchor-id="data-structures">1.4 Data Structures</h2>
</section>
<section id="baseline-model-linear-regression" class="level2">
<h2 class="anchored" data-anchor-id="baseline-model-linear-regression">Baseline model: Linear Regression</h2>
<p>We need to set a target for the neuron network to beat, if any model cannot beat a linear approximation of stock market in the long run it is a failure.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># custom train test val split with a smaller dataset. </span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the data from the database</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">'data/tables.db'</span>)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># show database content</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>cursor <span class="op">=</span> conn.cursor()</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>cursor.execute(<span class="st">"SELECT name FROM sqlite_master WHERE type='table';"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cursor.fetchall())</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract two tables from it and store them in two pd df</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> pd.read_sql_query(<span class="st">"SELECT * from df_2023_h1_feature"</span>, conn)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> pd.read_sql_query(<span class="st">"SELECT * from df_2023_h1_target"</span>, conn)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> ds.drop([<span class="st">'[QUOTE_DATE]'</span>, <span class="st">'[EXPIRE_DATE]'</span>, <span class="st">'Adj Close'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> ds[<span class="dv">0</span>:<span class="dv">10000</span>]</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> target[<span class="dv">0</span>:<span class="dv">10000</span>]</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>X_val <span class="op">=</span> ds[<span class="dv">10001</span>:<span class="dv">11001</span>]</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>y_val <span class="op">=</span> target[<span class="dv">10001</span>:<span class="dv">11001</span>]</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> ds[<span class="dv">11002</span>: <span class="dv">12002</span>]</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> target[<span class="dv">11002</span>: <span class="dv">12002</span>]</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(X_train.shape, y_train.shape, X_val.shape, y_val.shape, </span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    X_test.shape, y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>[(<span class="st">'df_2023_h1_feature'</span>,), (<span class="st">'df_2023_h1_target'</span>,)]</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>(<span class="dv">10000</span>, <span class="dv">21</span>) (<span class="dv">10000</span>, <span class="dv">1</span>) (<span class="dv">1000</span>, <span class="dv">21</span>) (<span class="dv">1000</span>, <span class="dv">1</span>) (<span class="dv">1000</span>, <span class="dv">21</span>) (<span class="dv">1000</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> pd.read_sql_query(<span class="st">"SELECT * from df_2023_h1_target"</span>, conn)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>target</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
discounted_price
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
-279.724554
</td>
</tr>
<tr>
<th>
1
</th>
<td>
-269.902630
</td>
</tr>
<tr>
<th>
2
</th>
<td>
-260.080706
</td>
</tr>
<tr>
<th>
3
</th>
<td>
-250.258782
</td>
</tr>
<tr>
<th>
4
</th>
<td>
-245.347819
</td>
</tr>
<tr>
<th>
…
</th>
<td>
…
</td>
</tr>
<tr>
<th>
127485
</th>
<td>
-17.254494
</td>
</tr>
<tr>
<th>
127486
</th>
<td>
-12.346804
</td>
</tr>
<tr>
<th>
127487
</th>
<td>
-7.439115
</td>
</tr>
<tr>
<th>
127488
</th>
<td>
-2.531426
</td>
</tr>
<tr>
<th>
127489
</th>
<td>
2.376263
</td>
</tr>
</tbody>
</table>
<p>
127490 rows × 1 columns
</p>
</div>
<p>Utilizing a simple linear regression model from sklearn, we can get a baseline model to compare with our neural network.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> metrics</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>reg <span class="op">=</span> LinearRegression()</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>reg.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<style>#sk-container-id-1 {color: black;}#sk-container-id-1 pre{padding: 0;}#sk-container-id-1 div.sk-toggleable {background-color: white;}#sk-container-id-1 label.sk-toggleable__label {cursor: pointer;display: block;width: 100%;margin-bottom: 0;padding: 0.3em;box-sizing: border-box;text-align: center;}#sk-container-id-1 label.sk-toggleable__label-arrow:before {content: "▸";float: left;margin-right: 0.25em;color: #696969;}#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {color: black;}#sk-container-id-1 div.sk-estimator:hover label.sk-toggleable__label-arrow:before {color: black;}#sk-container-id-1 div.sk-toggleable__content {max-height: 0;max-width: 0;overflow: hidden;text-align: left;background-color: #f0f8ff;}#sk-container-id-1 div.sk-toggleable__content pre {margin: 0.2em;color: black;border-radius: 0.25em;background-color: #f0f8ff;}#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {max-height: 200px;max-width: 100%;overflow: auto;}#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {content: "▾";}#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 input.sk-hidden--visually {border: 0;clip: rect(1px 1px 1px 1px);clip: rect(1px, 1px, 1px, 1px);height: 1px;margin: -1px;overflow: hidden;padding: 0;position: absolute;width: 1px;}#sk-container-id-1 div.sk-estimator {font-family: monospace;background-color: #f0f8ff;border: 1px dotted black;border-radius: 0.25em;box-sizing: border-box;margin-bottom: 0.5em;}#sk-container-id-1 div.sk-estimator:hover {background-color: #d4ebff;}#sk-container-id-1 div.sk-parallel-item::after {content: "";width: 100%;border-bottom: 1px solid gray;flex-grow: 1;}#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {background-color: #d4ebff;}#sk-container-id-1 div.sk-serial::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: 0;}#sk-container-id-1 div.sk-serial {display: flex;flex-direction: column;align-items: center;background-color: white;padding-right: 0.2em;padding-left: 0.2em;position: relative;}#sk-container-id-1 div.sk-item {position: relative;z-index: 1;}#sk-container-id-1 div.sk-parallel {display: flex;align-items: stretch;justify-content: center;background-color: white;position: relative;}#sk-container-id-1 div.sk-item::before, #sk-container-id-1 div.sk-parallel-item::before {content: "";position: absolute;border-left: 1px solid gray;box-sizing: border-box;top: 0;bottom: 0;left: 50%;z-index: -1;}#sk-container-id-1 div.sk-parallel-item {display: flex;flex-direction: column;z-index: 1;position: relative;background-color: white;}#sk-container-id-1 div.sk-parallel-item:first-child::after {align-self: flex-end;width: 50%;}#sk-container-id-1 div.sk-parallel-item:last-child::after {align-self: flex-start;width: 50%;}#sk-container-id-1 div.sk-parallel-item:only-child::after {width: 0;}#sk-container-id-1 div.sk-dashed-wrapped {border: 1px dashed gray;margin: 0 0.4em 0.5em 0.4em;box-sizing: border-box;padding-bottom: 0.4em;background-color: white;}#sk-container-id-1 div.sk-label label {font-family: monospace;font-weight: bold;display: inline-block;line-height: 1.2em;}#sk-container-id-1 div.sk-label-container {text-align: center;}#sk-container-id-1 div.sk-container {/* jupyter's `normalize.less` sets `[hidden] { display: none; }` but bootstrap.min.css set `[hidden] { display: none !important; }` so we also need the `!important` here to be able to override the default hidden behavior on the sphinx rendered scikit-learn.org. See: https://github.com/scikit-learn/scikit-learn/issues/21755 */display: inline-block !important;position: relative;}#sk-container-id-1 div.sk-text-repr-fallback {display: none;}</style>
<div id="sk-container-id-1" class="sk-top-container">
<div class="sk-text-repr-fallback">
<pre>LinearRegression()</pre>
<b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br>On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b>
</div>
<div class="sk-container" hidden="">
<div class="sk-item">
<div class="sk-estimator sk-toggleable">
<input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" checked=""><label for="sk-estimator-id-1" class="sk-toggleable__label sk-toggleable__label-arrow">LinearRegression</label>
<div class="sk-toggleable__content">
<pre>LinearRegression()</pre>
</div>
</div>
</div>
</div>
</div>
<p>With this code block we can output a r2_list to check r2 and mse for a range of values for their relationship with the distance with train set, and output plot graphs.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>r2_list <span class="op">=</span> []</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>mse_list <span class="op">=</span> []</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>X_list <span class="op">=</span> []</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>):</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    X_test <span class="op">=</span> ds.iloc[<span class="dv">10000</span> <span class="op">+</span> i <span class="op">*</span> <span class="dv">10000</span>:<span class="dv">11000</span> <span class="op">+</span> i <span class="op">*</span> <span class="dv">10000</span>]</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    y_test <span class="op">=</span> target.iloc[<span class="dv">10000</span> <span class="op">+</span> i <span class="op">*</span> <span class="dv">10000</span>:<span class="dv">11000</span> <span class="op">+</span> i <span class="op">*</span> <span class="dv">10000</span>]</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> reg.predict(X_test)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    X_list.append(<span class="dv">10000</span> <span class="op">+</span> i <span class="op">*</span> <span class="dv">10000</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>    r2_list.append(metrics.r2_score(y_true<span class="op">=</span>y_test, y_pred<span class="op">=</span>y_pred))</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>    mse_list.append(metrics.mean_squared_error(y_true<span class="op">=</span>y_test, y_pred<span class="op">=</span>y_pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>plt.plot(X_list, r2_list)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'R2 Score for baseline model'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>Text(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="st">'R2 Score for baseline model'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="p1.png" class="img-fluid figure-img"></p>
<figcaption>R2 Score baseline</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>plt.plot(X_list, mse_list)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'MSE Loss for baseline model'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>Text(<span class="fl">0.5</span>, <span class="fl">1.0</span>, <span class="st">'MSE Loss for baseline model'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="p2.png" class="img-fluid figure-img"></p>
<figcaption>MSE Loss baseline</figcaption>
</figure>
</div>
<p>Linear regression model is not performing well after 80000 rows, which shows that the linear approximation of stock is not good enough for prediction further into the future. We shall see the CNN performance in the next section.</p>
</section>
</section>
<section id="part-2-one-dimensional-convolutional-neural-network-cnn-for-predictions-of-intrinsic-value-of-call-and-put-option" class="level1">
<h1>Part 2: One-Dimensional Convolutional Neural Network (CNN) for Predictions of Intrinsic value of call and put option</h1>
<p>After data-preprocessing, we have deepened our understanding of the dataset and the information contained in each column. Since our goal is to predict the intrinsic value of stocks, which by definition is a regression problem, we will use a one-dimensional Convolutional Neural Network (CNN) to predict the intrinsic value of call and put options. The predictions provide a good estimate of the intrinsic value of the options, which can be used as a reference for the amount of payoff that the options will provide.</p>
<section id="feature-and-target-selection" class="level2">
<h2 class="anchored" data-anchor-id="feature-and-target-selection">2.1 Feature and Target Selection</h2>
<p>The first step of our model building process is to select the features and target. We will use PyTorch to build the CNN model. PyTorch is a popular open-source machine learning library based on the Torch library, flexible and powerful for machine learning tasks. We will use the <code>torch</code> and <code>torchvision</code> libraries to build the CNN model.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision <span class="im">import</span> datasets</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.transforms <span class="im">import</span> ToTensor </span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After importing all the necessary libraries, we will load the preprocessed dataset from the database. By using the <code>sqlite3</code> library, we can connect to the database and load the dataset into a pandas dataframe. As shown below, we first create a cursor and use the SQL command to fetch the data from the database. We have two tables in the database, one for feature, and the other for target.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Read in the data from the database</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>conn <span class="op">=</span> sqlite3.<span class="ex">connect</span>(<span class="st">'tables.db'</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>cursor <span class="op">=</span> conn.cursor()</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>cursor.execute(<span class="st">"SELECT name FROM sqlite_master WHERE type='table';"</span>)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cursor.fetchall())</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract two tables from it and store them in two pd df</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> pd.read_sql_query(<span class="st">"SELECT * from df_2023_h1_feature"</span>, conn)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>target <span class="op">=</span> pd.read_sql_query(<span class="st">"SELECT * from df_2023_h1_target"</span>, conn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>[(<span class="st">'df_2023_h1_feature'</span>,), (<span class="st">'df_2023_h1_target'</span>,)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We first take a look at the feature table named <code>ds</code>, and we make a copy of it for backup. As shown below, the feature table has a structure of 331609 rows × 22 columns, which has been preprossed in the previous section. We will then do feature selection from it.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>ds_new <span class="op">=</span> ds.copy()</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>ds</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="table">
<colgroup>
<col style="width: 8%">
<col style="width: 21%">
<col style="width: 17%">
<col style="width: 11%">
<col style="width: 22%">
<col style="width: 12%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th>Index</th>
<th>[QUOTE_UNIXTIME]</th>
<th>[EXPIRE_UNIX]</th>
<th>[STRIKE]</th>
<th>[UNDERLYING_LAST]</th>
<th>[C_DELTA]</th>
<th>…</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>-1.69160</td>
<td>-1.531564</td>
<td>-1.054517</td>
<td>-2.406592</td>
<td>1.054125</td>
<td>…</td>
</tr>
<tr class="even">
<td>1</td>
<td>-1.69160</td>
<td>-1.531564</td>
<td>-0.936052</td>
<td>-2.406592</td>
<td>1.041020</td>
<td>…</td>
</tr>
<tr class="odd">
<td>2</td>
<td>-1.69160</td>
<td>-1.531564</td>
<td>-0.888665</td>
<td>-2.406592</td>
<td>1.035470</td>
<td>…</td>
</tr>
<tr class="even">
<td>3</td>
<td>-1.69160</td>
<td>-1.531564</td>
<td>-0.876819</td>
<td>-2.406592</td>
<td>1.048893</td>
<td>…</td>
</tr>
<tr class="odd">
<td>4</td>
<td>-1.69160</td>
<td>-1.531564</td>
<td>-0.864972</td>
<td>-2.406592</td>
<td>1.030873</td>
<td>…</td>
</tr>
<tr class="even">
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr class="odd">
<td>331604</td>
<td>1.78216</td>
<td>1.881977</td>
<td>0.367073</td>
<td>1.410238</td>
<td>-0.175447</td>
<td>…</td>
</tr>
<tr class="even">
<td>331605</td>
<td>1.78216</td>
<td>1.881977</td>
<td>0.426306</td>
<td>1.410238</td>
<td>-0.288188</td>
<td>…</td>
</tr>
<tr class="odd">
<td>331606</td>
<td>1.78216</td>
<td>1.881977</td>
<td>0.485538</td>
<td>1.410238</td>
<td>-0.406236</td>
<td>…</td>
</tr>
<tr class="even">
<td>331607</td>
<td>1.78216</td>
<td>1.881977</td>
<td>0.544771</td>
<td>1.410238</td>
<td>-0.524528</td>
<td>…</td>
</tr>
<tr class="odd">
<td>331608</td>
<td>1.78216</td>
<td>1.881977</td>
<td>0.604004</td>
<td>1.410238</td>
<td>-0.647832</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>Theen we take a glance at the target table with merely one column named “discounted_price”. This column will be the target for our CNN model, as all feature engineering has been done in the data preprocessing phase.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>target</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div>

<table class="dataframe table table-sm table-striped small">
<thead>
<tr>
<th>
</th>
<th>
discounted_price
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
0
</th>
<td>
-63.916774
</td>
</tr>
<tr>
<th>
1
</th>
<td>
-54.101350
</td>
</tr>
<tr>
<th>
2
</th>
<td>
-50.175181
</td>
</tr>
<tr>
<th>
3
</th>
<td>
-49.193639
</td>
</tr>
<tr>
<th>
4
</th>
<td>
-48.212096
</td>
</tr>
<tr>
<th>
…
</th>
<td>
…
</td>
</tr>
<tr>
<th>
331604
</th>
<td>
-18.619560
</td>
</tr>
<tr>
<th>
331605
</th>
<td>
-13.711848
</td>
</tr>
<tr>
<th>
331606
</th>
<td>
-8.804136
</td>
</tr>
<tr>
<th>
331607
</th>
<td>
-3.896425
</td>
</tr>
<tr>
<th>
331608
</th>
<td>
1.011287
</td>
</tr>
</tbody>
</table>
<p>
331609 rows × 1 columns
</p>
</div>
<p>For the feature and target selections, we first concatenate the feature and target tables together.</p>
<div id="cell-55" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge target and ds directly, as they match and have the same length</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>ds_new <span class="op">=</span> pd.concat([ds_new, target], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-56" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>ds_new.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>Index(['[QUOTE_UNIXTIME]', '[EXPIRE_UNIX]', '[STRIKE]', '[UNDERLYING_LAST]',
       '[C_DELTA]', '[C_GAMMA]', '[C_VEGA]', '[C_THETA]', '[C_RHO]', '[C_IV]',
       '[C_VOLUME]', '[C_BID]', '[C_ASK]', '[P_DELTA]', '[P_GAMMA]',
       '[P_VEGA]', '[P_THETA]', '[P_RHO]', '[P_IV]', '[P_VOLUME]', '[P_BID]',
       '[P_ASK]', 'discounted_price'],
      dtype='object')</code></pre>
</div>
</div>
<p>We finalize the features and target_1 as our final features and target for the 1D CNN model. We select all option greeks for call and put as well as the quote and expire dates for features; and we multiply the “price_diff” by the exp(-rt) to get the target_1.</p>
<div id="cell-58" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> ds_new[[<span class="st">'[QUOTE_UNIXTIME]'</span>, <span class="st">'[EXPIRE_UNIX]'</span>, <span class="st">'[STRIKE]'</span>, </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'[UNDERLYING_LAST]'</span>, <span class="st">'[C_DELTA]'</span>, <span class="st">'[C_GAMMA]'</span>, <span class="st">'[C_VEGA]'</span>,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>       <span class="st">'[C_THETA]'</span>, <span class="st">'[C_RHO]'</span>, <span class="st">'[C_IV]'</span>, <span class="st">'[C_VOLUME]'</span>,<span class="st">'[C_BID]'</span>, </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>       <span class="st">'[C_ASK]'</span>, <span class="st">'[P_DELTA]'</span>, <span class="st">'[P_GAMMA]'</span>, <span class="st">'[P_VEGA]'</span>, <span class="st">'[P_THETA]'</span>,</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>       <span class="st">'[P_RHO]'</span>, <span class="st">'[P_IV]'</span>, <span class="st">'[P_VOLUME]'</span>, <span class="st">'[P_BID]'</span>, <span class="st">'[P_ASK]'</span>]].values</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>target_1<span class="op">=</span> ds_new[<span class="st">'discounted_price'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="train-validation-and-test-data-split" class="level2">
<h2 class="anchored" data-anchor-id="train-validation-and-test-data-split">2.2 Train, Validation, and Test Data Split</h2>
<p>After feature engineering, we now do the train, validation, and test data split. We will directly use slicing to create the three datasets but not sklearn’s train_test_split function, because each expire date has multiple strike prices, so we need to ensure the integrity of each expire date’s information. The proportion of the train, validation, and test datasets is 0.8, 0.1, and 0.1, respectively. We will use the first 80% of the data for training, the next 10% for validation, and the last 10% for testing.</p>
<div id="cell-61" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Manually using slicing to create the train, validation and test dataset in percentage of 80, 10, 10</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> features[:<span class="bu">int</span>(<span class="fl">0.8</span><span class="op">*</span><span class="bu">len</span>(features))]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>X_val <span class="op">=</span> features[<span class="bu">int</span>(<span class="fl">0.8</span><span class="op">*</span><span class="bu">len</span>(features)):<span class="bu">int</span>(<span class="fl">0.9</span><span class="op">*</span><span class="bu">len</span>(features))]</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> features[<span class="bu">int</span>(<span class="fl">0.9</span><span class="op">*</span><span class="bu">len</span>(features)):]</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> target_1[:<span class="bu">int</span>(<span class="fl">0.8</span><span class="op">*</span><span class="bu">len</span>(target_1))]</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>y_val <span class="op">=</span> target_1[<span class="bu">int</span>(<span class="fl">0.8</span><span class="op">*</span><span class="bu">len</span>(target_1)):<span class="bu">int</span>(<span class="fl">0.9</span><span class="op">*</span><span class="bu">len</span>(target_1))]</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> target_1[<span class="bu">int</span>(<span class="fl">0.9</span><span class="op">*</span><span class="bu">len</span>(target_1)):]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we convert these datasets to PyTorch tensors, and then we print out the shapes of the three datasets to ensure that the data split is successful.</p>
<div id="cell-63" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the data to tensor</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> torch.from_numpy(X_train).<span class="bu">type</span>(torch.Tensor)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>X_val <span class="op">=</span> torch.from_numpy(X_val).<span class="bu">type</span>(torch.Tensor)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> torch.from_numpy(X_test).<span class="bu">type</span>(torch.Tensor)</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>y_train <span class="op">=</span> torch.from_numpy(y_train.values).<span class="bu">type</span>(torch.Tensor)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>y_val <span class="op">=</span> torch.from_numpy(y_val.values).<span class="bu">type</span>(torch.Tensor)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>y_test <span class="op">=</span> torch.from_numpy(y_test.values).<span class="bu">type</span>(torch.Tensor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-64" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Train shapes:"</span>, X_train.shape, y_train.shape)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Validation shapes:"</span>, X_val.shape, y_val.shape)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Test shapes:"</span>, X_test.shape, y_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train shapes: torch.Size([265287, 22]) torch.Size([265287])
Validation shapes: torch.Size([33161, 22]) torch.Size([33161])
Test shapes: torch.Size([33161, 22]) torch.Size([33161])</code></pre>
</div>
</div>
<p>We need to do some unsqueeze operations to make the data suitable for the CNN model. The CNN model requires the input to be in the shape of (batch_size, channels, sequence_length), so we need to unsqueeze the second dimension of the input data to make it suitable for the CNN model.</p>
<div id="cell-66" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>X_train <span class="op">=</span> X_train.unsqueeze(<span class="dv">2</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(X_train.shape)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>X_val <span class="op">=</span> X_val.unsqueeze(<span class="dv">2</span>)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(X_val.shape)</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>X_test <span class="op">=</span> X_test.unsqueeze(<span class="dv">2</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(X_test.shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([265287, 22, 1])
torch.Size([33161, 22, 1])
torch.Size([33161, 22, 1])</code></pre>
</div>
</div>
</section>
<section id="d-cnn-model-construction" class="level2">
<h2 class="anchored" data-anchor-id="d-cnn-model-construction">2.3 1D CNN Model Construction</h2>
<p>As all the data is ready, we now construct the 1D CNN Model for the intrinsic value prediction. Before building the class of the model, we first import all torch related libraries and then define the model, including the torch.nn.functional library.</p>
<div id="cell-69" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In order to ensure the robustness and generalization of the model, the CNN we create has the following structure:</p>
<ol type="1">
<li><p><strong>Initial Convolution Block:</strong></p>
<ul>
<li>Conv1d: 22 input channels, 64 output channels, kernel size=3, stride=1, padding=1</li>
<li>BatchNorm1d: 64 features (output channels)</li>
</ul></li>
</ol>
<ul>
<li><strong><em>Interpretation: The initial convolution block is used to extract the features from the input data, and the batch normalization layer is used to normalize the features to ensure that the features are in the same scale.</em></strong></li>
</ul>
<ol start="2" type="1">
<li><p><strong>Residual Chunk 1:</strong></p>
<ul>
<li>Conv1d: 64 input channels, 64 output channels, kernel size=3, padding=1</li>
<li>BatchNorm1d: 64 features</li>
<li>Conv1d: 64 input channels, 64 output channels, kernel size=3, padding=1</li>
<li>BatchNorm1d: 64 features</li>
<li><em>Note:</em> Residual connection adds the input of the chunk to its output after these layers.</li>
</ul></li>
</ol>
<ul>
<li><strong><em>Interpretation: The first residual chunk preserves the number of channels at 64 but allows the model to learn an identity function easily, ensuring the layer can improve performance without hurting existing capabilities. It also helps solve gradient vanishing problem.</em></strong></li>
</ul>
<ol start="3" type="1">
<li><p><strong>Residual Chunk 2:</strong></p>
<ul>
<li>Conv1d: 64 input channels, 128 output channels, kernel size=3, padding=1, stride=2</li>
<li>BatchNorm1d: 128 features</li>
<li>Conv1d: 128 input channels, 128 output channels, kernel size=3, padding=1</li>
<li>BatchNorm1d: 128 features</li>
<li>Shortcut Connection (for residual addition):
<ul>
<li>Conv1d: 64 input channels, 128 output channels, kernel size=1, stride=2</li>
</ul></li>
</ul></li>
</ol>
<ul>
<li><strong><em>Interpretation: The second residual chunk includes a shortcut connection with a 1D convolutional layer (<code>self.res2_shortcut</code>) to match the dimensionality change for the residual connection. Other functionalities remain the same as the first Res Chunk.</em></strong></li>
</ul>
<ol start="4" type="1">
<li><p><strong>Dropout Layer:</strong></p>
<ul>
<li>Dropout: 0.3 probability.</li>
<li><strong><em>Interpretation: The dropout layer is pplied to reduce overfitting by randomly setting input elements to zero during training with a probability of 0.3 (<code>self.dropout</code>).</em></strong></li>
</ul></li>
<li><p><strong>Adaptive Pooling and Fully Connected Layers:</strong></p>
<ul>
<li>AdaptiveAvgPool1d: Output size of 1</li>
<li>Linear FC layer: 128 input features, 128 output features</li>
<li>Dropout: 0.3 probability</li>
<li>Linear FC layer: 128 input features, 128 output features</li>
<li>Dropout: 0.3 probability</li>
<li>Linear FC layer: 128 input features, 128 output features</li>
<li>Dropout: 0.3 probability</li>
<li>Linear FC layer: 128 input features, 1 output feature</li>
</ul></li>
</ol>
<ul>
<li><strong><em>Interpretation: The adaptive pooling layer is used to output a fixed-length output irrespective of input size, facilitating the connection to fully connected layers. The linear fully connected layers with dropoutapplied between them help to further prevent overfitting. The last fully connected layer reduces the output to 1 dimension.</em></strong></li>
</ul>
<p>And the visualization of the model structure is shown below: <img src="Conv1D.png" class="img-fluid" alt="1D CNN Structure Diagram"></p>
<p>We then import the python file CNN_CODE.py to access the CNN class and all necessary code, and then inspect to use them.</p>
<div id="cell-71" class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> CNN_CODE <span class="im">import</span> Convolution1D</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> inspect</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(inspect.getsource(Convolution1D))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Convolution1D(nn.Module):</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">'''</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co">        Convolutional Neural Network with 1D convolutions</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co">        params:</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="co">        - input_channels: number of input channels</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co">        - output_channels: number of output channels</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="co">        - kernel_size: size of the kernel</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a><span class="co">        - stride: stride of the kernel</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a><span class="co">        - padding: padding of the kernel</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co">        '''</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(Convolution1D, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initial Convolution</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 22 input channels (features), 64 output channels, 3x3 kernel</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv1 <span class="op">=</span> nn.Conv1d(in_channels<span class="op">=</span><span class="dv">22</span>, out_channels<span class="op">=</span><span class="dv">64</span>, </span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>                               kernel_size<span class="op">=</span><span class="dv">3</span>, stride<span class="op">=</span><span class="dv">1</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Batch Normalization with 64 features</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.bninit <span class="op">=</span> nn.BatchNorm1d(<span class="dv">64</span>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Residual chunk 1</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.res1_conv1 <span class="op">=</span> nn.Conv1d(<span class="dv">64</span>, <span class="dv">64</span>, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.res1_bn1 <span class="op">=</span> nn.BatchNorm1d(<span class="dv">64</span>)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.res1_conv2 <span class="op">=</span> nn.Conv1d(<span class="dv">64</span>, <span class="dv">64</span>, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.res1_bn2 <span class="op">=</span> nn.BatchNorm1d(<span class="dv">64</span>)</span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Residual chunk 2</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.res2_conv1 <span class="op">=</span> nn.Conv1d(<span class="dv">64</span>, <span class="dv">128</span>, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>, </span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>                                stride<span class="op">=</span><span class="dv">2</span>)  <span class="co"># Reduce dimensionality</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.res2_bn1 <span class="op">=</span> nn.BatchNorm1d(<span class="dv">128</span>)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.res2_conv2 <span class="op">=</span> nn.Conv1d(<span class="dv">128</span>, <span class="dv">128</span>, <span class="dv">3</span>, padding<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.res2_bn2 <span class="op">=</span> nn.BatchNorm1d(<span class="dv">128</span>)</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.res2_shortcut <span class="op">=</span> nn.Conv1d(<span class="dv">64</span>, <span class="dv">128</span>, <span class="dv">1</span>, </span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>                            stride<span class="op">=</span><span class="dv">2</span>)  <span class="co"># Shortcut to match dimensions</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Dropout layer</span></span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(<span class="fl">0.3</span>)</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Final global pooling and fully connected layers</span></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.global_pool <span class="op">=</span> nn.AdaptiveAvgPool1d(<span class="dv">1</span>)</span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc1 <span class="op">=</span> nn.Linear(<span class="dv">128</span>, <span class="dv">128</span>)</span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc2 <span class="op">=</span> nn.Linear(<span class="dv">128</span>, <span class="dv">128</span>)</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc3 <span class="op">=</span> nn.Linear(<span class="dv">128</span>, <span class="dv">128</span>)</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc4 <span class="op">=</span> nn.Linear(<span class="dv">128</span>, <span class="dv">1</span>)</span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initial conv layer</span></span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> F.relu(<span class="va">self</span>.bninit(<span class="va">self</span>.conv1(x)))</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Residual Chunk 1</span></span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>        res1 <span class="op">=</span> <span class="va">self</span>.res1_conv1(x)</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>        res1 <span class="op">=</span> F.relu(<span class="va">self</span>.res1_bn1(res1))</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>        res1 <span class="op">=</span> <span class="va">self</span>.res1_conv2(res1)</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> F.relu(x <span class="op">+</span> res1)</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Residual Chunk 2</span></span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>        res2 <span class="op">=</span> <span class="va">self</span>.res2_conv1(x)</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a>        res2 <span class="op">=</span> F.relu(<span class="va">self</span>.res2_bn1(res2))</span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a>        res2 <span class="op">=</span> <span class="va">self</span>.res2_conv2(res2)</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a>        shortcut <span class="op">=</span> <span class="va">self</span>.res2_shortcut(x)</span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> F.relu(res2 <span class="op">+</span> shortcut)</span>
<span id="cb37-62"><a href="#cb37-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-63"><a href="#cb37-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Final layers</span></span>
<span id="cb37-64"><a href="#cb37-64" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.global_pool(x)</span>
<span id="cb37-65"><a href="#cb37-65" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> torch.flatten(x, <span class="dv">1</span>)</span>
<span id="cb37-66"><a href="#cb37-66" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.dropout(x)</span>
<span id="cb37-67"><a href="#cb37-67" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> F.relu(<span class="va">self</span>.fc1(x))</span>
<span id="cb37-68"><a href="#cb37-68" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.dropout(F.relu(<span class="va">self</span>.fc2(x)))</span>
<span id="cb37-69"><a href="#cb37-69" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.dropout(F.relu(<span class="va">self</span>.fc3(x)))</span>
<span id="cb37-70"><a href="#cb37-70" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.fc4(x)</span>
<span id="cb37-71"><a href="#cb37-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-72"><a href="#cb37-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> x</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="model-training-and-validation" class="level2">
<h2 class="anchored" data-anchor-id="model-training-and-validation">2.4 Model Training and Validation</h2>
<p>As we constructed our CNN model, we now train and validate the model. We first define the loss function and the optimizer, using the Mean Squared Error (MSE) loss function to calculate the loss and the Adam optimizer to optimize the model. We set the learning rate as 0.01 and the weight decay as 0.0001. We also set various hyperparameters, including the number of epochs and the device to train the model. We set the number of epochs to 100 and the device to “cuda” if it is available; otherwise, we use “cpu”.</p>
<p>Also, for preventing early stopping, we use the <code>patience</code> parameter to set the number of epochs to wait for improvement before stopping the training process. We set the <code>patience</code> to 15, which means that if the validation loss does not improve for 15 epochs, the training process will stop. We also set the L2 regularization to 0.0001 to prevent overfitting.</p>
<p>Then, we create a loop to train and validate the model. We first set the model to training mode and then iterate through the training dataset, then compute the loss and update the model parameters using the optimizer, with the backward propagation.</p>
<p>After this, we set the model to evaluation mode and iterate through the validation dataset to calculate the validation loss. We also print out the training and validation loss for each epoch to monitor the training process. Should the early stopping condition is met, we use <code>torch.save</code> to save the model and stop the training process. The training and validation loss of each epoch are stored, and they are printed as below.</p>
<div id="cell-75" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> optim</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> Convolution1D()</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>val_loss_list, train_loss_list <span class="op">=</span>[],[]</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>final_epoch <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> nn.MSELoss()</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> torch.optim.Adam(model.parameters(), lr<span class="op">=</span><span class="fl">1e-2</span>, weight_decay<span class="op">=</span><span class="fl">1e-4</span>)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">'cuda'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="co"># For early stopping</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>patience <span class="op">=</span> <span class="dv">15</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>optimal_val_loss <span class="op">=</span> np.inf</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>current_patience <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Training phase</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>num_epochs <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(num_epochs):</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    model.train()</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    optimizer.zero_grad()</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    outputs <span class="op">=</span> model(X_train).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    loss <span class="op">=</span> criterion(outputs, y_train)</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    train_loss_list.append(loss)</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Backward and optimize</span></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    optimizer.zero_grad()</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    loss.backward()</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>    optimizer.step()</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validation phase</span></span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>        val_outputs <span class="op">=</span> model(X_val).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>        val_loss <span class="op">=</span> criterion(val_outputs, y_val)</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>        val_loss_list.append(val_loss)</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Early stopping</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> val_loss <span class="op">&lt;</span> optimal_val_loss:</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>            optimal_val_loss <span class="op">=</span> val_loss</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>            torch.save(model.state_dict(), <span class="st">'best_model.pt'</span>)</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>            current_patience <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>            current_patience <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> current_patience <span class="op">==</span> patience:</span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="ss">f'Early stopping at epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>                final_epoch <span class="op">=</span> epoch</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>                <span class="co"># load best model</span></span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>                model.load_state_dict(torch.load(<span class="st">'best_model.pt'</span>))</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (epoch<span class="op">+</span><span class="dv">1</span>) <span class="op">%</span> <span class="dv">1</span> <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f'Epoch [</span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>num_epochs<span class="sc">}</span><span class="ss">], Loss: </span><span class="sc">{</span>loss<span class="sc">.</span>item()<span class="sc">}</span><span class="ss">, </span></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a><span class="er">              Val Loss: {val_loss.item</span>()}<span class="st">')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch [1/100], Loss: 9172.8681640625, Val Loss: 1818.197265625
Epoch [2/100], Loss: 9102.5693359375, Val Loss: 1751.77685546875
Epoch [3/100], Loss: 8275.830078125, Val Loss: 1398.82080078125
Epoch [4/100], Loss: 5244.42724609375, Val Loss: 681.4796752929688
Epoch [5/100], Loss: 7110.5087890625, Val Loss: 1006.462890625
Epoch [6/100], Loss: 3426.317626953125, Val Loss: 1126.9154052734375
Epoch [7/100], Loss: 4286.83154296875, Val Loss: 938.3817749023438
Epoch [8/100], Loss: 4022.037109375, Val Loss: 682.0269165039062
Epoch [9/100], Loss: 3196.9482421875, Val Loss: 917.9542236328125
Epoch [10/100], Loss: 3701.21533203125, Val Loss: 181.23085021972656
Epoch [11/100], Loss: 1524.900634765625, Val Loss: 389.5296936035156
Epoch [12/100], Loss: 1103.0982666015625, Val Loss: 1594.5777587890625
Epoch [13/100], Loss: 1861.9698486328125, Val Loss: 2287.84619140625
Epoch [14/100], Loss: 2340.36279296875, Val Loss: 1141.52294921875
Epoch [15/100], Loss: 1081.2857666015625, Val Loss: 313.52301025390625
Epoch [16/100], Loss: 581.6431274414062, Val Loss: 108.076416015625
Epoch [17/100], Loss: 932.9679565429688, Val Loss: 140.25146484375
Epoch [18/100], Loss: 1336.6429443359375, Val Loss: 145.90013122558594
Epoch [19/100], Loss: 1214.3756103515625, Val Loss: 147.10081481933594
Epoch [20/100], Loss: 815.1370239257812, Val Loss: 339.05621337890625
Epoch [21/100], Loss: 572.9165649414062, Val Loss: 836.8012084960938
Epoch [22/100], Loss: 672.4065551757812, Val Loss: 1281.7899169921875
Epoch [23/100], Loss: 980.5892944335938, Val Loss: 1051.82470703125
Epoch [24/100], Loss: 892.7532958984375, Val Loss: 498.3086853027344
Epoch [25/100], Loss: 542.4771728515625, Val Loss: 207.02662658691406
Epoch [26/100], Loss: 491.0587463378906, Val Loss: 146.8715362548828
Epoch [27/100], Loss: 674.1841430664062, Val Loss: 121.95735168457031
Epoch [28/100], Loss: 770.651611328125, Val Loss: 80.98929595947266
Epoch [29/100], Loss: 654.6914672851562, Val Loss: 91.96054077148438
Epoch [30/100], Loss: 492.27069091796875, Val Loss: 207.66490173339844
Epoch [31/100], Loss: 465.4485168457031, Val Loss: 369.939453125
Epoch [32/100], Loss: 586.9057006835938, Val Loss: 391.50579833984375
Epoch [33/100], Loss: 624.5753173828125, Val Loss: 241.49102783203125
Epoch [34/100], Loss: 500.69305419921875, Val Loss: 101.10918426513672
Epoch [35/100], Loss: 427.59552001953125, Val Loss: 51.98616027832031
Epoch [36/100], Loss: 483.1625061035156, Val Loss: 47.67477798461914
Epoch [37/100], Loss: 545.8229370117188, Val Loss: 41.39034652709961
Epoch [38/100], Loss: 508.1427917480469, Val Loss: 36.485774993896484
Epoch [39/100], Loss: 438.0169677734375, Val Loss: 54.16953659057617
Epoch [40/100], Loss: 421.1383056640625, Val Loss: 88.96914672851562
Epoch [41/100], Loss: 471.10845947265625, Val Loss: 100.9154281616211
Epoch [42/100], Loss: 480.3539123535156, Val Loss: 75.54594421386719
Epoch [43/100], Loss: 429.4358215332031, Val Loss: 47.808441162109375
Epoch [44/100], Loss: 406.1731262207031, Val Loss: 37.47623825073242
Epoch [45/100], Loss: 435.10394287109375, Val Loss: 32.7606086730957
Epoch [46/100], Loss: 452.689697265625, Val Loss: 29.308931350708008
Epoch [47/100], Loss: 420.9671630859375, Val Loss: 36.494937896728516
Epoch [48/100], Loss: 396.0536193847656, Val Loss: 55.476470947265625
Epoch [49/100], Loss: 404.5439453125, Val Loss: 68.0870361328125
Epoch [50/100], Loss: 423.883544921875, Val Loss: 56.49263381958008
Epoch [51/100], Loss: 408.332275390625, Val Loss: 35.67536163330078
Epoch [52/100], Loss: 384.791748046875, Val Loss: 25.1159725189209
Epoch [53/100], Loss: 388.8431091308594, Val Loss: 23.977157592773438
Epoch [54/100], Loss: 401.4180603027344, Val Loss: 23.906402587890625
Epoch [55/100], Loss: 395.3701477050781, Val Loss: 24.9521484375
Epoch [56/100], Loss: 379.8179931640625, Val Loss: 29.47606658935547
Epoch [57/100], Loss: 381.36181640625, Val Loss: 33.6275520324707
Epoch [58/100], Loss: 389.26708984375, Val Loss: 31.371234893798828
Epoch [59/100], Loss: 382.2471008300781, Val Loss: 26.508771896362305
Epoch [60/100], Loss: 369.72607421875, Val Loss: 24.71722984313965
Epoch [61/100], Loss: 373.2747802734375, Val Loss: 24.789255142211914
Epoch [62/100], Loss: 372.1296691894531, Val Loss: 25.448476791381836
Epoch [63/100], Loss: 372.6578063964844, Val Loss: 27.88591957092285
Epoch [64/100], Loss: 366.294189453125, Val Loss: 32.301979064941406
Epoch [65/100], Loss: 366.24237060546875, Val Loss: 34.39863967895508
Epoch [66/100], Loss: 362.286376953125, Val Loss: 31.689903259277344
Epoch [67/100], Loss: 360.7981872558594, Val Loss: 28.11236572265625
Epoch [68/100], Loss: 357.0233459472656, Val Loss: 27.745023727416992
Early stopping at epoch 69</code></pre>
</div>
</div>
<p>As shown above, the training phase terminates at epoch 69 due to early stopping, and we can see the rapid decrease of both training and validation loss in the first couple of epochs, which means that the model is learning well. For the last epoch, which is epoch 62, the validation loss is around 27.74, which is a good result for our model. This is because the intrinsic value of the options has a range of over 600, and the square root of the loss is around 5.26, which is a small percentage of the intrinsic value.</p>
</section>
<section id="model-testing-and-analysis-of-testing-results" class="level2">
<h2 class="anchored" data-anchor-id="model-testing-and-analysis-of-testing-results">2.5 Model Testing and Analysis of Testing Results</h2>
<p>After finishing the training and validation process, we test the model using the test dataset. We first load the saved model and set it to evaluation mode. Then we iterate through the test dataset to calculate the test loss. We also print out the test loss to evaluate the performance of the model, as shown below.</p>
<div id="cell-79" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">eval</span>()</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> torch.no_grad():</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> model(X_test).squeeze(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    test_loss <span class="op">=</span> criterion(predictions, y_test)</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Test Loss: </span><span class="sc">{</span>test_loss<span class="sc">.</span>item()<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> torch.nn.MSELoss()</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>mse_loss <span class="op">=</span> criterion(predictions, y_test)</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"MSE Loss: </span><span class="sc">{</span>mse_loss<span class="sc">.</span>item()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"RMSE Loss: </span><span class="sc">{</span>(mse_loss.item()<span class="op">**</span>(<span class="fl">0.5</span>))<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="co"># R2 score</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>r2 <span class="op">=</span> r2_score(y_test, predictions)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"R2 Score: </span><span class="sc">{</span>r2<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test Loss: 34.36250305175781
MSE Loss: 34.36250305175781
RMSE Loss: 5.8619538595725755
R2 Score: 0.9812109767170123</code></pre>
</div>
</div>
<p>As shown above, we get the test loss(MSE) of around 34.26, which indicates that the model is performing well on the test dataset. As the fluctuation of the intrinsic value of the options is large with a range of 350, the test loss of 34.26 is a good result for our model. We then visualize the predicted intrinsic value and the actual intrinsic value of the options to see how well the model performs. We plot the predicted intrinsic value and the actual intrinsic value of the options within the test dataset using matplotlib, as shown below.</p>
<div id="cell-81" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>,<span class="dv">7</span>))</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>plt.plot(predictions, label<span class="op">=</span><span class="st">'Predicted'</span>,color <span class="op">=</span> <span class="st">'red'</span>)</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>plt.plot(y_test, label <span class="op">=</span> <span class="st">"True"</span>, color <span class="op">=</span> <span class="st">'blue'</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Test Set Predictions'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>Text(0.5, 1.0, 'Test Set Predictions')</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-13-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The visualization above sufficiently showcases the complexity of the intrinsic value and the model’s strong ability to capture the features of the intrinsic value. As the blue curve stands for the ground truth, and the red curve stands for the predictions, we can see that the red curve is very close to the blue curve and two curves largely overlap. This indicates that the model we construct is robust and generalizes well to the test dataset.</p>
<p>We also visualize the train and validation losses, as we need to see if there is any overfitting or underfitting. We first convert each element in two lists storing validation and train losses from torch tensor to numpy array. Then we use matplotlib to draw the plot.</p>
<p>As shown below, the train and validation losses are plotted against the number of epochs. We observe that there is no evidence of overfitting here. Both losses decrease rapidly at the beginning with some fluctuations,but in general they tend to level off, suggesting that the model is learning generalizable patterns.</p>
<div id="cell-84" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>val_loss_numpy, train_loss_numpy <span class="op">=</span> [],[]</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> val_loss_list:</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    val_loss_numpy.append(i.numpy())</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> j <span class="kw">in</span> train_loss_list:</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    train_loss_numpy.append(j.detach().numpy())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-85" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>plt.plot(train_loss_numpy, label<span class="op">=</span><span class="st">'Train Loss'</span>)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>plt.plot(val_loss_numpy, label<span class="op">=</span><span class="st">'Validation Loss'</span>)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Loss'</span>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Train vs Validation Loss"</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/cell-15-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>From our experience with the baseline Linear Regression Model and Autogluon Model, the R2 score drops quickly against time periods, and MSE loss shoots up fast. With the CNN model, we tested both against time as a metric against previous models. The timestamp in these graphs is standardized.</p>
<div id="cell-87" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>test_part <span class="op">=</span> y_test.numpy()</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="co"># print(len(test_part))</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>pred_part <span class="op">=</span> predictions.numpy()</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># print(len(another))</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>test_part <span class="op">=</span> pd.DataFrame(test_part)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>pred_part <span class="op">=</span> pd.DataFrame(pred_part)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>ds_test <span class="op">=</span> ds_new[<span class="bu">int</span>(<span class="fl">0.9</span><span class="op">*</span><span class="bu">len</span>(features)):].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co"># print(ds_test)</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>test_part.columns <span class="op">=</span> [<span class="st">'true_intrinsic'</span>]</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>pred_part.columns <span class="op">=</span> [<span class="st">'pred_intrinsic'</span>]</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>together <span class="op">=</span> pd.concat([ds_test, test_part],axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>together <span class="op">=</span> pd.concat([together, pred_part],axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="co"># print(together)</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(together.columns)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Index(['[QUOTE_UNIXTIME]', '[EXPIRE_UNIX]', '[STRIKE]', '[UNDERLYING_LAST]',
       '[C_DELTA]', '[C_GAMMA]', '[C_VEGA]', '[C_THETA]', '[C_RHO]', '[C_IV]',
       '[C_VOLUME]', '[C_BID]', '[C_ASK]', '[P_DELTA]', '[P_GAMMA]',
       '[P_VEGA]', '[P_THETA]', '[P_RHO]', '[P_IV]', '[P_VOLUME]', '[P_BID]',
       '[P_ASK]', 'discounted_price', 'true_intrinsic', 'pred_intrinsic'],
      dtype='object')</code></pre>
</div>
</div>
<div id="cell-88" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> metrics</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>result_df <span class="op">=</span> together</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="sourceCode" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'timestamp'</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'R2 score'</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"R2 score Across Time"</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>plt.plot(result_df[[<span class="st">'[QUOTE_UNIXTIME]'</span>, <span class="st">'true_intrinsic'</span>, </span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="st">'pred_intrinsic'</span>]].groupby(<span class="st">'[QUOTE_UNIXTIME]'</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> x: </span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>metrics.r2_score(x[<span class="st">'true_intrinsic'</span>], x[<span class="st">'pred_intrinsic'</span>])))</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The R2 score trend shown below is kind of turbulent, and in general the R2 score remains stable over time. Also, R2 score has a much better performance than the baseline model as we can see its value never goes below 0.95.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="o1.png" class="img-fluid figure-img"></p>
<figcaption>R2 score Across Time</figcaption>
</figure>
</div>
<div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'timestamp'</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'MSE Loss'</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"MSE Loss Across Time"</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>plt.plot(result_df[[<span class="st">'[QUOTE_UNIXTIME]'</span>, <span class="st">'true_intrinsic'</span>, </span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="st">'pred_intrinsic'</span>]].groupby(<span class="st">'[QUOTE_UNIXTIME]'</span>).<span class="bu">apply</span>(<span class="kw">lambda</span> x: </span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>metrics.mean_squared_error(x[<span class="st">'true_intrinsic'</span>], x[<span class="st">'pred_intrinsic'</span>])))</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>THe MSE loss also performs a fluctuating trend, but it is way smaller than the baseline model’s MSE loss. So the CNN model is a good choice for the intrinsic value prediction of options and the performance is pretty good.</p>
<p>[<img src="o2.png" class="img-fluid" alt="MSE Loss Across Time"></p>
<p>With similar test and train sizes, the CNN model produces much more stable results over extended periods of time than other models. With a rather random and non-Gaussian dataset, this BEYOND-PIC16B-level model performs relatively well into the future and can produce better results than traditional machine learning algorithms utilized in PIC16A.</p>
</section>
</section>
<section id="part-3-flask-web-app-development-for-option-intrinsic-value-prediction" class="level1">
<h1>Part 3: Flask Web App Development for Option Intrinsic Value Prediction</h1>
<p>After completing data preprocessing and constructing a one-dimensional Convolutional Neural Network (CNN), we have successfully enabled the prediction of call and put options’ intrinsic values. The subsequent step involves operationalizing this model: we will explore how to integrate it into a web application, thus allowing users to make predictions and view results. This transition marks our shift from theoretical analysis to practical application, demonstrating the real-world utility of our intellectual efforts.</p>
<section id="web-app-implementation-outline" class="level2">
<h2 class="anchored" data-anchor-id="web-app-implementation-outline">3.0 Web App Implementation Outline</h2>
<p>The implementation strategy for our Flask web application development can be encapsulated as follows:</p>
<ol type="1">
<li><p><strong>Web Application Framework Construction</strong>: Utilize the Flask framework to build a web application that processes user-uploaded financial data and displays prediction outcomes.</p></li>
<li><p><strong>Model Preparation</strong>: Define a Convolutional Neural Network (CNN) specifically designed for financial data prediction. This model includes multiple convolutional layers, batch normalization layers, and residual connections to boost performance and training efficiency—a milestone already achieved by our team.</p></li>
<li><p><strong>Model Loading and Data Preprocessing</strong>: Load the pre-trained model (<code>best_model_ultimatel.pth</code>) and perform data preprocessing. This step involves reading data from an uploaded CSV file and applying the preprocess_data function to execute feature scaling, data splitting, and other preparatory operations, mirroring the CNN model setup.</p></li>
<li><p><strong>Model Training and Prediction</strong>: Employ the PyTorch library to load the pre-trained model and input the preprocessed data for prediction.</p></li>
<li><p><strong>Results Presentation</strong>: Exhibit the model’s performance metrics on the test dataset, such as Mean Squared Error (MSE), Root Mean Squared Error (RMSE), and R-squared score, along with the prediction outcomes. These are visualized using <code>Plotly</code> charts, providing a comprehensive view to the users.</p></li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="flask1.png" class="img-fluid figure-img"></p>
<figcaption>Our whole flask folder(flask.op.PerfectFINALver)</figcaption>
</figure>
</div>
<ul>
<li><p><code>app.py</code>: Central to the application, this file contains key functions like <code>Convolution1D</code>, <code>preprocess_data</code>, <code>Index</code>, <code>show_prediction</code>, <code>get_table_info</code>, <code>view_uploaded_database</code>, and <code>view_database</code>, which are integral to the app’s operation.</p></li>
<li><p><code>Templates</code> folder: This directory holds all the HTML files needed for the app’s user interface, enabling interactions and data display. It includes <code>index.html</code>, <code>plot.html</code>, <code>view_uploaded_data.html</code>, <code>show_prediction.html</code>, <code>Test_Set_Predictions.html</code>, and <code>view_data.html</code>.</p></li>
<li><p><code>Data</code> folder: Contains sample CSV files, <code>df_2023_h1_feature.csv</code> and <code>df_2023_h1_target.csv</code>, used for data upload and result demonstration in the app.</p></li>
<li><p><code>Model</code> folder: Houses the pre-trained model file essential for making data predictions.</p></li>
<li><p><code>__pycache__</code> folder: A system-generated directory that caches bytecode, enhancing the program’s execution speed.</p></li>
<li><p><code>Static</code> folder: Stores static files, crucial for the app’s styling and interactive features.</p></li>
</ul>
<p>This organizational structure ensures that each aspect of our Flask web application is well-arranged and easily accessible, supporting efficient development and maintenance.</p>
</section>
<section id="overview-and-impact-analysis-of-functions-in-app.py" class="level2">
<h2 class="anchored" data-anchor-id="overview-and-impact-analysis-of-functions-in-app.py">3.1 Overview and Impact Analysis of Functions in app.py</h2>
<p>In the <code>app.py</code> file, several key functionalities are pivotal to the web application’s operation, specifically tailored for financial data analysis and option pricing evaluation. These include:</p>
<ol type="1">
<li><strong>Upload and Preprocess Financial Data</strong>: This functionality allows users to upload their financial datasets and applies preprocessing techniques to prepare the data for analysis.</li>
<li><strong>View Uploaded CSV Files</strong>: Users can view the list of uploaded CSV files, providing an overview of the data available for processing.</li>
<li><strong>View Details of the Uploaded CSV Files</strong>: This feature enables users to delve into the specifics of each uploaded CSV file, examining the data more closely.</li>
<li><strong>Evaluate Option Pricing and Display Evaluation Results</strong>: The application assesses the pricing of options based on the uploaded data and displays the results, offering valuable insights into option valuation.</li>
</ol>
<p>The <code>app.py</code> file incorporates essential libraries and modules to facilitate web development, data processing, machine learning, and visualization:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> Flask, render_template, url_for, request, flash, redirect</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> werkzeug.utils <span class="im">import</span> secure_filename</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch.nn.functional <span class="im">as</span> F</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> flask <span class="im">import</span> jsonify</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sqlite3</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> plotly.graph_objects <span class="im">as</span> go</span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="convolution1d-class" class="level3">
<h3 class="anchored" data-anchor-id="convolution1d-class">Convolution1D Class</h3>
<p>The <code>Convolution1D</code> class within our application is a custom neural network module extending <code>nn.Module</code> from PyTorch, designed for one-dimensional convolutional operations. This class embodies a series of convolutional, batch normalization, and fully connected layers, structured to facilitate complex pattern recognition in financial data. Notably, this implementation includes residual connections and dropout for robustness and generalization.</p>
<p>Note: Building on the foundational work previously established by our team members, this segment is presented without extensive analysis to minimize redundancy.</p>
</section>
<section id="torch.load" class="level3">
<h3 class="anchored" data-anchor-id="torch.load">Torch.load</h3>
<p>In this section of the code, we address the computational efficiency and resource optimization for running our neural network model. The code snippet demonstrates the dynamic allocation of processing units, preferring GPU over CPU for faster computation, which is crucial for handling complex models like <code>Convolution1D</code>. We then load the model’s state dictionary from the file ‘best_model_ultimate.pt’. The <code>map_location</code> argument ensures that the loaded state dict is moved to the appropriate device. This step initializes the model with previously trained parameters, allowing for further training,evaluation, or inference without retraining from scratch. Here’s a detailed look at the operations:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for available GPU, otherwise use CPU</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">'cuda'</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">'cpu'</span>)</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the Convolution1D model and transfer it to the chosen device</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>model_loaded <span class="op">=</span> Convolution1D().to(device)</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the previously trained model state</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>model_loaded.load_state_dict(torch.load(<span class="st">'model/best_model_new.pt'</span>, map_location<span class="op">=</span>device))</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the model to evaluation mode</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>model_loaded.<span class="bu">eval</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="preprocess_data" class="level3">
<h3 class="anchored" data-anchor-id="preprocess_data">Preprocess_data</h3>
<p>The <code>preprocess_data</code> function tasked with preparing the financial data for subsequent analysis. It performs several key steps:</p>
<ul>
<li><strong>Data Loading</strong>: Reads the financial datasets from the specified CSV files.</li>
<li><strong>Normalization</strong>: Applies <code>StandardScaler</code> to normalize specific columns, ensuring uniform data scaling.</li>
<li><strong>Data Merging</strong>: Combines the feature and target data into a single DataFrame for comprehensive analysis.</li>
<li><strong>Data Splitting</strong>: Segregates the dataset into training, validation, and test sets, facilitating a structured approach to model training and evaluation.</li>
</ul>
<p>Given that these processes align with our prior data handling endeavors, we will highlight only the main actions and points, avoiding detailed analysis to prevent redundancy.</p>
</section>
<section id="index" class="level3">
<h3 class="anchored" data-anchor-id="index">Index()</h3>
<p>The <code>index</code> function in <code>app.py</code> serves as the main entry point for our Flask web application. It handles both GET and POST requests, managing file uploads, data preprocessing, model evaluation, and rendering the results. This function aligns with our previous work, emphasizing efficient data processing and model integration. Key points include handling file uploads, data preprocessing, model prediction, error calculation, and result visualization. Below is the detailed code:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">'/'</span>, methods<span class="op">=</span>[<span class="st">'GET'</span>, <span class="st">'POST'</span>])</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> index():</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="co">    This function serves as the endpoint for the root URL ('/'). </span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="co">    It handles both GET and POST requests,</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="co">    rendering the index page of the web application. </span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="co">    During a POST request, it processes uploaded files</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a><span class="co">    for option pricing evaluation, performs predictions, and returns the results </span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="co">    along with rendering the HTML template.</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a><span class="co">        render_template: Renders the HTML template based on the </span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a><span class="co">        request method and the operations performed.</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the request method is POST, which indicates that data has been </span></span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># submitted to the server</span></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> request.method <span class="op">==</span> <span class="st">'POST'</span>:</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if both files are present in the request</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="st">'file1'</span> <span class="kw">not</span> <span class="kw">in</span> request.files <span class="kw">or</span> <span class="st">'file2'</span> <span class="kw">not</span> <span class="kw">in</span> request.files:</span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If either file is missing, flash a message to the user and </span></span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>            <span class="co"># reload the page</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>            flash(<span class="st">'No file part'</span>)</span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(request.url)</span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>        file1 <span class="op">=</span> request.files[<span class="st">'file1'</span>]</span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>        file2 <span class="op">=</span> request.files[<span class="st">'file2'</span>]</span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if file names are not empty, meaning that the user </span></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a>        <span class="co"># has selected files</span></span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> file1.filename <span class="op">==</span> <span class="st">''</span> <span class="kw">or</span> file2.filename <span class="op">==</span> <span class="st">''</span>:</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If no file is selected, flash a message and reload the page</span></span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>            flash(<span class="st">'No selected file'</span>)</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> redirect(request.url)</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if both files exist and proceed with processing</span></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> file1 <span class="kw">and</span> file2:</span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Secure the file names and prepare the file paths</span></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a>            filename1 <span class="op">=</span> secure_filename(file1.filename)</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>            filename2 <span class="op">=</span> secure_filename(file2.filename)</span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>            file1_path <span class="op">=</span> os.path.join(app.config[<span class="st">'UPLOAD_FOLDER'</span>], </span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>            filename1)</span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>            file2_path <span class="op">=</span> os.path.join(app.config[<span class="st">'UPLOAD_FOLDER'</span>], </span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>            filename2)</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the files to the server</span></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>            file1.save(file1_path)</span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>            file2.save(file2_path)</span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Notify the user that files have been uploaded successfully</span></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>            flash(<span class="st">'Files successfully uploaded'</span>)</span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Preprocess the data from the uploaded files</span></span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a>            X_train, X_val, X_test, y_train, y_val, </span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a>            y_test <span class="op">=</span> preprocess_data(file1_path,  file2_path)</span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Evaluate the model on the uploaded data</span></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a>            criterion <span class="op">=</span> nn.MSELoss()  <span class="co"># Mean Squared Error Loss function</span></span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">with</span> torch.no_grad():  <span class="co"># No gradient computation for evaluation </span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a>                <span class="co"># to save memory and computations</span></span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a>                output <span class="op">=</span> model_loaded(X_test.to(device)).squeeze(<span class="op">-</span><span class="dv">1</span>)  </span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Model prediction</span></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a>                predictions <span class="op">=</span> output</span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a>                test_loss <span class="op">=</span> criterion(predictions, y_test.to(device))  </span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Calculate the test loss</span></span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Compute the Root Mean Square Error (RMSE) for the test data</span></span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a>            mse_loss <span class="op">=</span> criterion(predictions, y_test)</span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>            rmse_loss <span class="op">=</span> mse_loss.item() <span class="op">**</span> (<span class="fl">0.5</span>)</span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Compute the R-squared (R2) score to measure the goodness of fit</span></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a>            <span class="im">from</span> sklearn.metrics <span class="im">import</span> r2_score</span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a>            r2 <span class="op">=</span> r2_score(y_test, predictions)</span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Create a plot of the predictions against the true values</span></span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a>            fig <span class="op">=</span> go.Figure()</span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a>            fig.add_trace(go.Scatter(x<span class="op">=</span>np.arange(<span class="bu">len</span>(output)), </span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span>output.squeeze().numpy(), mode<span class="op">=</span><span class="st">'lines'</span>, name<span class="op">=</span><span class="st">'Predicted'</span>, </span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a>            line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'red'</span>)))</span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a>            fig.add_trace(go.Scatter(x<span class="op">=</span>np.arange(<span class="bu">len</span>(y_test)), </span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span>y_test.numpy(), mode<span class="op">=</span><span class="st">'lines'</span>, name<span class="op">=</span><span class="st">'True'</span>, line<span class="op">=</span><span class="bu">dict</span>(color<span class="op">=</span><span class="st">'blue'</span>)))</span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a>            fig.update_layout(title<span class="op">=</span><span class="st">'Test Set Predictions'</span>, xaxis_title<span class="op">=</span><span class="st">'Index'</span>, </span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a>            yaxis_title<span class="op">=</span><span class="st">'Value'</span>)</span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Save the plot output to a file</span></span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a>            plot_output_path <span class="op">=</span> os.path.join(<span class="st">'static'</span>, <span class="st">'Test_Set_Predictions.html'</span>)</span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a>            fig.write_html(plot_output_path)</span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Render the index HTML template with the results and plot path</span></span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> render_template(<span class="st">'index.html'</span>, test_loss<span class="op">=</span>test_loss.item(), </span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a>            mse_loss<span class="op">=</span>mse_loss.item(),</span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a>                                   rmse_loss<span class="op">=</span>rmse_loss, r2_score<span class="op">=</span>r2,</span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a>                                    plot<span class="op">=</span>plot_output_path)</span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the request method is GET, render the index HTML </span></span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a>    <span class="co"># template without any prediction or plot</span></span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">'index.html'</span>, prediction<span class="op">=</span><span class="va">None</span>, plot<span class="op">=</span><span class="va">None</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In summary, the index function is integral to the Flask application. It is pivotal for deploying predictive models effectively, ensuring that the application not only performs its intended analytical tasks but also provides a user-friendly interface for interaction and result interpretation.</p>
</section>
<section id="show_prediction" class="level3">
<h3 class="anchored" data-anchor-id="show_prediction">show_prediction</h3>
<p>The <code>show_prediction</code> function in <code>app.py</code> is designed to handle GET requests specifically for displaying the prediction results on a separate page. This functionality is crucial for providing users with access to the outcome of their data analysis, ensuring a clear and dedicated view of the predictive results.</p>
<p>Here’s a detailed analysis of the function:</p>
<ul>
<li><p><strong>Path Definition</strong>: Initially, the function defines the path to the prediction results file, typically stored in the <code>static</code> directory. This standardization of file location facilitates consistent access and retrieval of the results.</p></li>
<li><p><strong>Existence Check</strong>: The function then checks if the prediction results file exists at the specified path. This check is essential to prevent errors that would occur if the application attempted to display a non-existent file.</p></li>
<li><p><strong>Conditional Rendering</strong>: If the file exists, the function proceeds to render an HTML template (<code>Test_Set_Predictions.html</code>) specifically designed to display the prediction results. This template is passed the path of the prediction plot file, ensuring that the correct data is displayed.</p></li>
<li><p><strong>Redirection</strong>: In cases where the prediction results file does not exist, the function redirects the user to the index page. This redirection mechanism prevents user confusion and ensures a smooth user experience by guiding them back to the starting point of the application.</p></li>
</ul>
<p>Here is the complete code snippet:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">'/show_prediction'</span>, methods<span class="op">=</span>[<span class="st">'GET'</span>])</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_prediction():</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Define the path to the prediction results file, </span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># assumed to be in the 'static' directory</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    plot_output_path <span class="op">=</span> os.path.join(<span class="st">'static'</span>, <span class="st">'Test_Set_Predictions.html'</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the prediction results file exists</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(plot_output_path):</span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If the file does not exist, redirect the user to the index page</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">'index'</span>))</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the file exists, render the template to display the prediction results,</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># passing the path of the prediction plot file to the template</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">'Test_Set_Predictions.html'</span>, </span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>    plot_output_path<span class="op">=</span>plot_output_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="get_table_info" class="level3">
<h3 class="anchored" data-anchor-id="get_table_info">get_table_info</h3>
<p>The <code>get_table_info</code> function is designed to streamline the process of extracting filenames from full file paths, which is a common requirement in web applications handling file uploads. By utilizing <code>os.path.basename</code>, it efficiently strips the directory path, leaving only the file name. This functionality is particularly useful in scenarios where the display or processing of filenames, independent of their storage paths, is required. Here’s how the function operates:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_table_info(file1_path, file2_path):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [os.path.basename(file1_path), os.path.basename(file2_path)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="view_uploaded_data" class="level3">
<h3 class="anchored" data-anchor-id="view_uploaded_data">view_uploaded_data</h3>
<p>The <code>view_uploaded_data</code> function in the Flask web application serves to showcase the files that have been uploaded by users. This endpoint, accessible via a GET request, retrieves and displays the contents of the upload directory in the application’s user interface. Here’s an in-depth look at the function and its code:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">'/view_uploaded_data'</span>, methods<span class="op">=</span>[<span class="st">'GET'</span>])</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> view_uploaded_data():</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Handles the GET request to display the uploaded database files.</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="co">    This endpoint fetches the list of files present in the upload </span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="co">    directory and displays them</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="co">    on the 'view_uploaded_data.html' page. </span></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="co">    This allows users to see which files have been</span></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="co">    uploaded to the application.</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a><span class="co">    The function retrieves the filenames from the specified </span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a><span class="co">    upload folder set in the app's configuration</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="co">    and passes these filenames to the rendering template.</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Retrieve the list of files in the upload directory</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>    files <span class="op">=</span> os.listdir(app.config[<span class="st">'UPLOAD_FOLDER'</span>])</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Render the HTML template, passing the list of files </span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> display on the webpage</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">'view_uploaded_data.html'</span>, files<span class="op">=</span>files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="view_data" class="level3">
<h3 class="anchored" data-anchor-id="view_data">view_data</h3>
<p>The <code>view_data</code> endpoint in the Flask application is designed to showcase the details of the uploaded CSV files through a GET request. It facilitates the inspection of the contents of these files, enhancing the user’s ability to interact with and analyze the uploaded data. The function operates by expecting <code>filename1</code> and <code>filename2</code> as query parameters, utilizing these to locate and display the respective files’ contents. Here’s a closer look at the function and its operations:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="at">@app.route</span>(<span class="st">'/view_data'</span>, methods<span class="op">=</span>[<span class="st">'GET'</span>])</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> view_data():</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co">    The function checks for the existence of the specified files </span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="co">    in the upload directory.</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="co">    If both files exist, it reads them as CSVs and prepares the data for viewing. </span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a><span class="co">    If either</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="co">    file is missing or an error occurs during file reading,</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="co">    the user is redirected to the file upload view </span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="co">    with an appropriate error message.</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Retrieve filenames from the request's query parameters</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>    filename1 <span class="op">=</span> request.args.get(<span class="st">'filename1'</span>)</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>    filename2 <span class="op">=</span> request.args.get(<span class="st">'filename2'</span>)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Validate that both filenames are provided</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> filename1 <span class="kw">or</span> <span class="kw">not</span> filename2:</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>        flash(<span class="st">'No data file selected.'</span>)</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">'view_uploaded_data'</span>))</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct full file paths</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>    file1_path <span class="op">=</span> os.path.join(app.config[<span class="st">'UPLOAD_FOLDER'</span>], filename1)</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>    file2_path <span class="op">=</span> os.path.join(app.config[<span class="st">'UPLOAD_FOLDER'</span>], filename2)</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if both files exist in the specified upload folder</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(file1_path) <span class="kw">or</span> <span class="kw">not</span> os.path.exists(file2_path):</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>        flash(<span class="st">'Data file not found.'</span>)</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">'view_uploaded_data'</span>))</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Attempt to read the files as CSVs and store their contents</span></span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>        ds <span class="op">=</span> pd.read_csv(file1_path)</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a>        target <span class="op">=</span> pd.read_csv(file2_path)</span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a>        table_data <span class="op">=</span> {<span class="st">'Dataset 1'</span>: ds, <span class="st">'Dataset 2'</span>: target}</span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Handle any error that occurs during file reading </span></span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># and flash an error message</span></span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>        flash(<span class="ss">f'Error accessing CSV files: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> redirect(url_for(<span class="st">'view_uploaded_data'</span>))</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Render the view template with the loaded table data and filenames</span></span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> render_template(<span class="st">'view_data.html'</span>, tables<span class="op">=</span>table_data,</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>     filename1<span class="op">=</span>filename1, filename2<span class="op">=</span>filename2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The concluding part of our Flask application’s code features the standard Python idiom to check if the script is executed as the main program and not imported as a module. This check is crucial for initiating the Flask server only when the script is run directly, ensuring that the application’s startup process is controlled and deliberate. The <code>app.run(debug=True)</code> line activates the Flask application server with debug mode enabled, which is beneficial during development for its detailed error feedback and live reloading capabilities. Here’s the segment:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This conditional statement checks if the script is run as the main program.</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure that code is only executed when the script is run directly,</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="co">#  and not when imported as a module.</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The app.run(debug=True) command starts the Flask application server.</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The debug=True argument enables debug mode, which provides useful </span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># feedback in the browser for development,</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># including detailed tracebacks and live reloading on code changes.</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    app.run(debug<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="evaluative-overview-of-html-templates-implications-for-user-interface-and-experience" class="level2">
<h2 class="anchored" data-anchor-id="evaluative-overview-of-html-templates-implications-for-user-interface-and-experience">3.2 Evaluative Overview of HTML Templates: Implications for User Interface and Experience</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="flask2.png" class="img-fluid figure-img"></p>
<figcaption>Overview of Templates Folder</figcaption>
</figure>
</div>
<p>Our web application uses a set of HTML templates, each carefully crafted to improve how users interact with and see data. These templates are essential to the app’s design, blending good looks with practical use. They guide users from the start of entering data to the end of seeing the results. - <code>index.html</code>: Serves as the primary gateway to the web application, designed for predicting call option values. It incorporates Bootstrap for styling, providing a responsive layout with file upload forms, navigation buttons, and result display sections, thus ensuring a user-friendly experience.</p>
<ul>
<li><p><code>plot.html</code>: Utilizes Plotly for dynamic data visualization, offering interactive charts that render complex datasets in an easily digestible format, enhancing the analytical capabilities of the application.</p></li>
<li><p><code>view_uploaded_data.html</code>: Lists the uploaded database files, enabling users to access and review the data they have provided, fostering transparency and control over the processed information.</p></li>
<li><p><code>view_data.html</code>: Exhibits the content from two distinct datasets, providing a comprehensive view of the data under analysis and facilitating a deeper understanding of the predictive context.</p></li>
<li><p><code>show_prediction.html</code>: Displays the outcome of predictive analyses, guiding users to detailed visual representations and insights derived from their data.</p></li>
<li><p><code>Test_Set_Predictions.html</code>: Incorporates Plotly JavaScript to generate interactive data visualizations, allowing for an engaging and informative exploration of predictive results within the web environment.</p></li>
</ul>
<p>Next, we will conduct a comprehensive analysis of each template’s functionalities and contributions, examining the web pages in our prototype to assess their quality and effectiveness.</p>
<section id="welcome-page" class="level3">
<h3 class="anchored" data-anchor-id="welcome-page">3.2.1 Welcome Page</h3>
<p>Our welcome page design seamlessly integrates various elements to optimize <code>user experience</code> and <code>functionality</code>. Users are provided with intuitive <code>"Browse" buttons</code> to swiftly upload local CSV files. Upon clicking the <code>"Upload &amp; Save" button</code>, evaluation results are promptly generated within a few-second timeframe, ensuring <code>efficiency</code> in data processing. Additionally, users can easily access and review their uploaded dataset (csv files) online by selecting the <code>"View Data"</code>. For a comprehensive analysis, users can explore <code>interactive prediction graphs</code> through the <code>"View Prediction" feature</code>, enhancing their ability to interpret and analyze data trends effectively.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="flask3.png" class="img-fluid figure-img"></p>
<figcaption>Welcome Page</figcaption>
</figure>
</div>
<section id="color-scheme-and-aesthetics-in-index.html" class="level4">
<h4 class="anchored" data-anchor-id="color-scheme-and-aesthetics-in-index.html">Color Scheme and Aesthetics in <code>index.html</code></h4>
<ul>
<li><strong>Color Choice:</strong> In <code>index.html</code>, we deliberately choose a light blue background color (#ADD8E6) to promote a serene ambiance conducive to focused reading and analysis. The semi-transparent white background (rgba(255, 255, 255, 0.8)) within container elements aims to highlight content while maintaining visual harmony.</li>
</ul>
<div class="sourceCode" id="cb59"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">style</span><span class="dt">&gt;</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    body {</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">background-color</span><span class="ch">:</span> <span class="cn">#ADD8E6</span><span class="op">;</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">padding-top</span><span class="ch">:</span> <span class="dv">20</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">display</span><span class="ch">:</span> <span class="dv">flex</span><span class="op">;</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">justify-content</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">align-items</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">height</span><span class="ch">:</span> <span class="dv">100</span><span class="dt">vh</span><span class="op">;</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">.container</span> {</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">max-width</span><span class="ch">:</span> <span class="dv">800</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">text-align</span><span class="ch">:</span> <span class="dv">center</span><span class="op">;</span></span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">background-color</span><span class="ch">:</span> <span class="fu">rgba(</span><span class="dv">255</span><span class="op">,</span> <span class="dv">255</span><span class="op">,</span> <span class="dv">255</span><span class="op">,</span> <span class="dv">0.8</span><span class="fu">)</span><span class="op">;</span></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">padding</span><span class="ch">:</span> <span class="dv">40</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">border-radius</span><span class="ch">:</span> <span class="dv">20</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* Additional CSS styles are defined in this section */</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">style</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="modular-design-with-bootstrap-in-index.html" class="level4">
<h4 class="anchored" data-anchor-id="modular-design-with-bootstrap-in-index.html">Modular Design with Bootstrap in <code>index.html</code></h4>
<ul>
<li><strong>Grid System Utilization:</strong> We utilize Bootstrap’s grid system to create a responsive layout, dividing content into grid columns with classes like <code>container</code>, <code>row</code>, and <code>col-*</code>, ensuring seamless alignment across devices. This fosters a visually appealing and user-friendly design. Here’s how it’s integrated:</li>
</ul>
<div class="sourceCode" id="cb60"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"container"</span><span class="dt">&gt;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Content structured using Bootstrap's grid system --&gt;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Custom CSS Classes Integration:</strong> Custom CSS classes are integrated to style elements such as buttons, forms, and text, maintaining a cohesive design language and enhancing visual appeal.</li>
</ul>
<div class="sourceCode" id="cb61"><pre class="sourceCode css code-with-copy"><code class="sourceCode css"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">.btn-group</span> <span class="fu">.btn</span> {</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">margin</span><span class="ch">:</span> <span class="dv">0</span> <span class="dv">10</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">font-size</span><span class="ch">:</span> <span class="dv">36</span><span class="dt">px</span><span class="op">;</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Responsive Design Features:</strong> Leveraging Bootstrap’s responsive utilities like breakpoints and flexbox classes (<code>d-flex</code>, <code>justify-content-center</code>, <code>align-items-center</code>), we ensure our webpage adapts smoothly to various screen sizes and orientations for optimal user experience.</li>
</ul>
<div class="sourceCode" id="cb62"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"container"</span><span class="dt">&gt;</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">iframe</span><span class="ot"> src</span><span class="op">=</span><span class="st">"{{ plot }}"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"100%"</span><span class="ot"> height</span><span class="op">=</span><span class="st">"500px"</span><span class="dt">&gt;&lt;/</span><span class="kw">iframe</span><span class="dt">&gt;</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Component Reusability:</strong> By using Bootstrap’s built-in components such as navigation bars, buttons, and forms, we enhance code modularity and maintain a consistent design language throughout the project, saving time and effort in UI development.</li>
</ul>
<div class="sourceCode" id="cb63"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> class</span><span class="op">=</span><span class="st">"btn-group"</span><span class="ot"> role</span><span class="op">=</span><span class="st">"group"</span><span class="ot"> aria-label</span><span class="op">=</span><span class="st">"Actions"</span><span class="dt">&gt;</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">a</span><span class="ot"> href</span><span class="op">=</span><span class="st">"{{ url_for('view_data') }}"</span><span class="ot"> class</span><span class="op">=</span><span class="st">"btn btn-info"</span><span class="dt">&gt;</span>View Data<span class="dt">&lt;/</span><span class="kw">a</span><span class="dt">&gt;</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">a</span><span class="ot"> href</span><span class="op">=</span><span class="st">"{{ url_for('show_prediction') }}"</span><span class="ot"> class</span><span class="op">=</span><span class="st">"btn btn-info"</span><span class="dt">&gt;</span>View Prediction<span class="dt">&lt;/</span><span class="kw">a</span><span class="dt">&gt;</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="evaluation-results-page" class="level3">
<h3 class="anchored" data-anchor-id="evaluation-results-page">3.2.2 Evaluation &amp; Results Page</h3>
<p>After clicking the <code>"Upload &amp; Save"</code> button, the client is directed to our <strong>Evaluation &amp; Results</strong> page, where they can view both numerical results and an interactive graph which provides visual insights, allowing users to explore and analyze the data trends effectively.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="flask4.png" class="img-fluid figure-img"></p>
<figcaption>Evaluation &amp; Results Page</figcaption>
</figure>
</div>
<p><strong>Numerical Results Display in <code>evaluate_and_visualize.html</code></strong></p>
<div class="sourceCode" id="cb64"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>{% if test_loss is defined %}</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h2</span><span class="dt">&gt;</span>Evaluation Results:<span class="dt">&lt;/</span><span class="kw">h2</span><span class="dt">&gt;</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>Test Loss: {{ test_loss }}<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>MSE Loss: {{ mse_loss }}<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>RMSE Loss: {{ rmse_loss }}<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>R2 Score: {{ r2_score }}<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">iframe</span><span class="ot"> src</span><span class="op">=</span><span class="st">"{{ plot }}"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"100%"</span><span class="ot"> height</span><span class="op">=</span><span class="st">"500px"</span><span class="dt">&gt;&lt;/</span><span class="kw">iframe</span><span class="dt">&gt;</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>{% endif %}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><strong>Clarity:</strong> The page presents evaluation metrics such as Test Loss, Mean Squared Error (MSE) Loss, Root Mean Squared Error (RMSE) Loss, and R-squared (R2) Score in a clear and structured manner using HTML <code>&lt;p&gt;</code> tags. This clarity enhances the understanding of model performance.</p></li>
<li><p><strong>Precision:</strong> The page ensures the precision and accuracy of displayed numerical values, crucial for data analysis. It typically maintains a precision of at least ten decimal places, ensuring data accuracy for in-depth analysis and comparison.</p></li>
<li><p><strong>Contextual Rendering:</strong> The use of conditional blocks ensures that numerical results are displayed only when relevant data is available, preventing confusion and presenting information contextually.</p></li>
</ul>
<p><strong>Embedding Plotly Graph in <code>evaluate_and_visualize.html</code></strong></p>
<div class="sourceCode" id="cb65"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">iframe</span><span class="ot"> src</span><span class="op">=</span><span class="st">"{{ plot }}"</span><span class="ot"> width</span><span class="op">=</span><span class="st">"100%"</span><span class="ot"> height</span><span class="op">=</span><span class="st">"500px"</span><span class="dt">&gt;&lt;/</span><span class="kw">iframe</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><strong>Visual Analysis:</strong> The page enhances data analysis by embedding a Plotly graph within an <code>&lt;iframe&gt;</code>. This interactive graph provides visual insights into trends and patterns, complementing the numerical results.</li>
<li><strong>Interactivity:</strong> Users can interact with the embedded Plotly graph, such as zooming, panning, and hovering over data points to view detailed information. This interactivity fosters a deeper understanding of data trends and anomalies.</li>
<li><strong>Integration:</strong> The seamless integration of the Plotly graph within the HTML page enhances user experience, allowing for a comprehensive analysis of model performance with both numerical and visual data representations.</li>
</ul>
</section>
<section id="view-data-page" class="level3">
<h3 class="anchored" data-anchor-id="view-data-page">3.2.3 View Data Page</h3>
<p>By clicking the “View Data” button, users are directed to the data page, where all previously uploaded data files are displayed. Each file is accompanied by a “View” button on the right-hand side, allowing users to view the uploaded data online with a single click.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="flask5.png" class="img-fluid figure-img"></p>
<figcaption>View Data Page</figcaption>
</figure>
</div>
<p><strong>File Listing in <code>view_data.html</code></strong></p>
<div class="sourceCode" id="cb66"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- Table body section to display the content. --&gt;</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">tbody</span><span class="dt">&gt;</span></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Loop through each file in the 'files' list passed from the Flask backend. --&gt;</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    {% for file in files %}</span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&lt;</span><span class="kw">td</span><span class="dt">&gt;</span>{{ file }}<span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="co">&lt;!-- Displaying the file name. --&gt;</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&lt;</span><span class="kw">td</span><span class="dt">&gt;&lt;</span><span class="kw">a</span><span class="ot"> href</span><span class="op">=</span><span class="st">"{{ url_for('view_data', filename1=file,</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="st">         filename2=file) }}"</span><span class="dt">&gt;</span>View<span class="dt">&lt;/</span><span class="kw">a</span><span class="dt">&gt;&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="co">&lt;!-- Link to view data. --&gt;</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>    {% endfor %}</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">tbody</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>The “File Name” column displays each uploaded file’s name, fetched from the <code>files</code> list passed from the backend. Within each table row (

), the file name is displayed in the “File Name” column (

{{ file }}

). This ensures that users can easily identify and select the files they want to view.</li>
</ul>
<p><strong>Actionable Links in <code>view_data.html</code></strong></p>
<div class="sourceCode" id="cb67"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">td</span><span class="dt">&gt;&lt;</span><span class="kw">a</span><span class="ot"> href</span><span class="op">=</span><span class="st">"{{ url_for('view_data', filename=file) }}"</span><span class="dt">&gt;</span>View<span class="dt">&lt;/</span><span class="kw">a</span><span class="dt">&gt;&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p>The “Actions” column provides a convenient “View” link for each file, allowing users to seamlessly navigate to detailed data views with a single click. This intuitive design enhances the overall user experience and promotes efficient data exploration.</p></li>
<li><p>The “View” links are dynamically generated using Flask’s powerful <code>url_for</code> function, ensuring accurate and reliable navigation to the corresponding data views.</p></li>
</ul>
</section>
<section id="view-uploaded-data-page" class="level3">
<h3 class="anchored" data-anchor-id="view-uploaded-data-page">3.2.4 View Uploaded Data Page</h3>
<p>When users click the “View” button on the View Data Page, they are seamlessly navigated to a dynamically generated web page that displays the data they have previously uploaded. This feature provides users with a convenient and intuitive way to access and examine their uploaded datasets within the application, enhancing the overall user experience and facilitating efficient data analysis.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="flask6.png" class="img-fluid figure-img"></p>
<figcaption>View Uploaded Data Page</figcaption>
</figure>
</div>
<p><strong>Dynamic Content Rendering in <code>view_uploaded_data.html</code></strong></p>
<p>The <code>&lt;tbody&gt;</code> section of the table dynamically displays uploaded files. This functionality is achieved through the use of server-side templating, specifically with Jinja2 in Flask, allowing for iteration over a list of files and rendering each as a row in the table.</p>
<ul>
<li><strong>Functionality</strong>: Iteration over the <code>files</code> array to create a table row for each file.</li>
<li><strong>Data Binding</strong>: Server-side rendering with <code>{ file }</code> to bind file names directly into the table.</li>
<li><strong>Dynamic URL Generation</strong>: The <code>url_for</code> function generates actionable links for each file, enabling user interaction.</li>
</ul>
<p>Here is the code snippet in <code>view_uploaded_data.html</code> illustrating this functionality:</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">tbody</span><span class="dt">&gt;</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Table body section to display the content. --&gt;</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    {% for file in files %}</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">&lt;!-- Loop through each file in the 'files' list</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co">     passed from the Flask backend. --&gt;</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&lt;</span><span class="kw">td</span><span class="dt">&gt;</span>{{ file }}<span class="dt">&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span> <span class="co">&lt;!-- Displaying the file name. --&gt;</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&lt;</span><span class="kw">td</span><span class="dt">&gt;&lt;</span><span class="kw">a</span><span class="ot"> href</span><span class="op">=</span><span class="st">"{{ url_for('view_data', </span></span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a><span class="st">        filename1=file, </span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a><span class="st">        filename2=file) }}"</span><span class="dt">&gt;</span>View<span class="dt">&lt;/</span><span class="kw">a</span><span class="dt">&gt;&lt;/</span><span class="kw">td</span><span class="dt">&gt;</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;/</span><span class="kw">tr</span><span class="dt">&gt;</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>    {% endfor %}</span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">tbody</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="view-prediction-page" class="level3">
<h3 class="anchored" data-anchor-id="view-prediction-page">3.2.5 View Prediction Page</h3>
<p>Upon selecting the “View Prediction” button on the initial interface, users are directed to a page displaying test set predictions, featuring an interactive graph created with Plotly. This visualization fosters an engaging user experience, permitting detailed examination of the predictions. The graph’s interactive features—zoom, pan, and data point hover—provide enriched informational access, allowing tailored analytical perspectives.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="flask7.png" class="img-fluid figure-img"></p>
<figcaption>View Prediction Page</figcaption>
</figure>
</div>
<p>The graph offers intuitive controls for a seamless user experience. Users can double-click to revert to the original zoom level after examining specific intervals. The operation bar in the upper right corner allows users to download the plot as a PNG, autoscale the axes, and reset the axes effortlessly.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="flask8.png" class="img-fluid figure-img"></p>
<figcaption>Prediction Focused on Certain Interval</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="flask9.png" class="img-fluid figure-img"></p>
<figcaption>Operation Bar</figcaption>
</figure>
</div>
<p><strong>Dynamic Plot Rendering with Plotly in <code>plot.html</code></strong></p>
<div class="sourceCode" id="cb69"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="ot"> src</span><span class="op">=</span><span class="st">"https://cdn.plot.ly/plotly-latest.min.js"</span><span class="dt">&gt;&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">div</span><span class="ot"> id</span><span class="op">=</span><span class="st">"plot"</span><span class="dt">&gt;&lt;/</span><span class="kw">div</span><span class="dt">&gt;</span></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">script</span><span class="dt">&gt;</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> plot_path <span class="op">=</span> <span class="st">"{{ plot_path }}"</span><span class="op">;</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    Plotly<span class="op">.</span><span class="at">d3</span><span class="op">.</span><span class="fu">html</span>(plot_path<span class="op">,</span> <span class="kw">function</span>(error<span class="op">,</span> data) {</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (error) {</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="bu">console</span><span class="op">.</span><span class="fu">warn</span>(error)<span class="op">;</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">document</span><span class="op">.</span><span class="fu">getElementById</span>(<span class="st">'plot'</span>)<span class="op">.</span><span class="at">innerHTML</span> <span class="op">=</span> data<span class="op">;</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;/</span><span class="kw">script</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><strong>Integration with Plotly:</strong> The inclusion of the Plotly library through the <code>&lt;script&gt;</code> tag is a significant aspect of this template.</p></li>
<li><p><strong>Asynchronous Data Fetching:</strong> The JavaScript block fetches the plot data asynchronously using Plotly’s d3.html function. This method loads the plot data from a specified path (plot_path), which is dynamically provided by the server-side application. This approach ensures that the webpage remains responsive and that the plot is updated seamlessly without the need for a full page reload.</p></li>
<li><p><strong>Dynamic Content Loading:</strong> The template utilizes an empty</p>
<div>
<p>element with the id plot, which serves as a placeholder for the graph. The actual content of the graph is loaded dynamically through JavaScript, enabling the webpage to render data-driven plots efficiently.</p></div></li>
</ul>
<p><strong>Conditional Rendering and Link Generation in <code>show_prediction.html</code></strong></p>
<div class="sourceCode" id="cb70"><pre class="sourceCode html code-with-copy"><code class="sourceCode html"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>{% if prediction %}</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">h3</span><span class="dt">&gt;</span>Predicted Mean: {{ prediction }}<span class="dt">&lt;/</span><span class="kw">h3</span><span class="dt">&gt;</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;&lt;</span><span class="kw">a</span><span class="ot"> href</span><span class="op">=</span><span class="st">"{{ plot }}"</span><span class="ot"> target</span><span class="op">=</span><span class="st">"_blank"</span><span class="dt">&gt;</span>View Test Set Predictions Plot<span class="dt">&lt;/</span><span class="kw">a</span><span class="dt">&gt;&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>{% else %}</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&lt;</span><span class="kw">p</span><span class="dt">&gt;</span>No prediction available<span class="dt">&lt;/</span><span class="kw">p</span><span class="dt">&gt;</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>{% endif %}</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="dt">&lt;</span><span class="kw">a</span><span class="ot"> href</span><span class="op">=</span><span class="st">"{{ url_for('index') }}"</span><span class="ot"> class</span><span class="op">=</span><span class="st">"btn btn-primary"</span><span class="dt">&gt;</span>Go Back<span class="dt">&lt;/</span><span class="kw">a</span><span class="dt">&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li><p><strong>Conditional Content Display:</strong> The template employs Jinja2’s conditional syntax {% if prediction %} to check the presence of a prediction variable. This approach ensures that the user interface adapts to the data context, displaying the prediction results when available. If the prediction variable contains a value, the template renders an <code>&lt;h3&gt;</code> tag showing the predicted mean, enhancing the user’s understanding of the model output.</p></li>
<li><p><strong>Dynamic Link Creation:</strong> The template dynamically generates a link to a plot <code>(&lt;a href="{{ plot }}" target="_blank"&gt;)</code> when prediction data is available. This link, opened in a new tab (target=“_blank”), leads to a detailed visualization of the test set predictions.</p></li>
</ul>
</section>
</section>
<section id="summary" class="level2">
<h2 class="anchored" data-anchor-id="summary">Summary</h2>
<p>Our web application, through its meticulously designed templates and key features, offers a streamlined and enriched user experience. We are committed to enabling users to efficiently manage, analyze, and interpret their data within a cohesive and intuitive environment. By providing a user-friendly interface and powerful functionality, we sincerely aim to empower users to harness the full potential of their data. Our goal is to support users in making informed decisions and fostering a deeper understanding of their analytical contexts.</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">4. Conclusion</h2>
<p>Based on above step-by-step instruction and illustrations about how we initiate our project of creating a 1D CNN model for predicting the intrinsic values of options and developing a Flask web application for operationalizing the model, we have successfully demonstrated the process of constructing a robust model for financial-related data analysis and integrating it into a user-friendly web interface. Our project embodies various stages, including data preprocessing, model development, training, evaluation, and web application deployment, thereby showcasing the end-to-end process of building a practical machine learning application.</p>
<p>Regarding the ethical ramifications of our project, we emphasize that due to the limitations of data and project complexity, this webapp should NEVER be used for ALL kinds of profit-making activities such as investment, but is only suitable for displaying the complexity and insights of option pricing related data. We adhere to ethical guidelines and promote responsible data handling throughout the development process. We respect copyright and ensure that the data used for the creation of WebApps comes from authoritative websites. We consider data privacy, transparency, and ensuring that users of our webapp have control over their data, understand how it is used, and know the entire process of our webapp creation.</p>
<p>Hope it shows some insights of option pricing, and thanks for reading!</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      return note.innerHTML;
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>